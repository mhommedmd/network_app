# โ ุฅุตูุงุญ ุญุณุงุจ ุงูุฑุตูุฏ ูู ุจุทุงูุฉ ุงููุชุฌุฑ

## ุงููุดููุฉ
ูู ุตูุญุฉ ุงููุชุงุฌุฑ (`accounts_page.dart`)ุ ูุงู ุงูุฑุตูุฏ ุงูุญุงูู ูููุชุฌุฑ **ูุง ูุธูุฑ** ุฑุบู ูุฌูุฏ ูุนุงููุงุช ููุฏููุนุงุช.

### ูุซุงู ุงููุดููุฉ
**ูุชุฌุฑ ูุญูู ุนุจุฏูู ูุงุฑุน:**
- ุงูุฑุตูุฏ ุงููุนูู: **175,000 ุฑ.ู** (ูู ุงููุนุงููุงุช)
- ุงููุฎุฒูู: **206 ูุฑุช** โ ูุธูุฑ
- ุงูุฑุตูุฏ ุงููุนุฑูุถ: **0 ุฑ.ู** โ ุฎุทุฃ!

---

## ุงูุณุจุจ ุงูุฌุฐุฑู

### ุงูุทุฑููุฉ ุงููุฏููุฉ (ุงูุฎุงุทุฆุฉ):
```dart
// ูุงู ูุฌูุจ ุงูุฑุตูุฏ ูู network_connections.balance
final balance = (data['balance'] as num?)?.toDouble() ?? 0.0;
```

### ุงููุดุงูู:
1. โ **ูุง ููุญุฏูุซ ุชููุงุฆูุงู**: `network_connections.balance` ุญูู ุซุงุจุช
2. โ **ูููุชุงุฌุฑ ุงููุฏููุฉ**: ูุฏ ูุง ููุฌุฏ ูุณุชูุฏ ูู `network_connections`
3. โ **ุบูุฑ ุฏููู**: ูุง ูุนูุณ ุงููุนุงููุงุช ุงููุนููุฉ

---

## ุงูุญู ุงูููุทุจู

### ุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ (ุงูุตุญูุญุฉ):
```dart
// ุญุณุงุจ ุงูุฑุตูุฏ ูู ูุนุงููุงุช transactions
Stream<Map<String, dynamic>> _getVendorRealTimeData() {
  return FirebaseFirestore.instance
      .collection('transactions')
      .where('networkId', isEqualTo: widget.vendor.networkId)
      .where('vendorId', isEqualTo: widget.vendor.id)
      .where('status', isEqualTo: 'completed')
      .snapshots()
      .asyncMap((transactionsSnapshot) async {
    
    double totalCharges = 0;  // ุงููุณุชุญูุงุช
    double totalPayments = 0; // ุงููุฏููุนุงุช
    
    for (final doc in transactionsSnapshot.docs) {
      final amount = (data['amount'] as num?)?.toDouble() ?? 0.0;
      final type = data['type'] as String?;
      
      if (type == 'cash_payment_received') {
        totalPayments += amount.abs();
      } else if (amount > 0) {
        totalCharges += amount;    // charge, fee
      } else if (amount < 0) {
        totalPayments += amount.abs(); // payment, refund
      }
    }
    
    // ุงูุฑุตูุฏ = ุงููุณุชุญูุงุช - ุงููุฏููุนุงุช
    final balance = totalCharges - totalPayments;
    
    return {'balance': balance, 'stock': stock};
  });
}
```

---

## ุงููุนุงุฏูุฉ

### ุงูุฑุตูุฏ ุงูุญุงูู:
```
ุงูุฑุตูุฏ = ุงููุณุชุญูุงุช - ุงููุฏููุนุงุช
```

### ุญูุซ:
- **ุงููุณุชุญูุงุช** = ูุฌููุน ุงููุจุงูุบ ุงูููุฌุจุฉ (ุทูุจุงุชุ ุฑุณูู...)
- **ุงููุฏููุนุงุช** = ูุฌููุน ุงููุจุงูุบ ุงูุณุงูุจุฉ (ุฏูุนุงุช ููุฏูุฉ...)

### ูุซุงู:
```
ุงููุณุชุญูุงุช:
  - ุทูุจ 1: +100,000
  - ุทูุจ 2: +80,000
  - ุทูุจ 3: +50,000
  ุงูุฅุฌูุงูู: 230,000

ุงููุฏููุนุงุช:
  - ุฏูุนุฉ 1: -30,000
  - ุฏูุนุฉ 2: -25,000
  ุงูุฅุฌูุงูู: 55,000

ุงูุฑุตูุฏ ุงูุญุงูู = 230,000 - 55,000 = 175,000 ุฑ.ู โ
```

---

## ุงูุชุญุณููุงุช

### โ Real-time Updates
- ูุณุชูุน ููุชุบููุฑุงุช ูู `transactions`
- ูุชุญุฏุซ ููุฑุงู ุนูุฏ ุฅุถุงูุฉ ูุนุงููุฉ ุฌุฏูุฏุฉ
- ูุชุญุฏุซ ููุฑุงู ุนูุฏ ุฏูุนุฉ ููุฏูุฉ

### โ ุฏูุฉ 100%
- ูุญุณุจ ูู ุงููุนุงููุงุช ุงููุนููุฉ
- ูุฏุนู ุงููุนุงููุงุช ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
- ูุชุนุงูู ูุน ุฌููุน ุฃููุงุน ุงููุนุงููุงุช

### โ ุงูุชูุงูููุฉ
- ูุนูู ูุน ุงููุชุงุฌุฑ ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
- ูุง ูุชุทูุจ ูุฌูุฏ `network_connections`
- ูุชูุงูู ูุน ุฌููุน ุนูููุงุช ุงููุนุงููุงุช

---

## ุนุฑุถ ุงูุฑุตูุฏ ูู ุงูุจุทุงูุฉ

### ุงูุชูุณูู:
```dart
Text(
  '${realBalance >= 0 ? '+' : ''}${realBalance.toStringAsFixed(0)}',
  style: TextStyle(
    fontSize: 15.sp,
    fontWeight: FontWeight.w800,
    color: realBalance > 0 ? AppColors.error : AppColors.success,
  ),
)
```

### ุงูุฃููุงู:
- **ุฃุญูุฑ** (error): ุฑุตูุฏ ููุฌุจ = ุงููุชุฌุฑ ูุฏูู ููุดุจูุฉ ๐ด
- **ุฃุฎุถุฑ** (success): ุฑุตูุฏ ุณุงูุจ ุฃู ุตูุฑ = ุงููุชุฌุฑ ูุณุฏุฏ โ

---

## Debug Logging

ุนูุฏ ุนุฑุถ ุจุทุงูุฉ ุงููุชุฌุฑุ ุณุชุธูุฑ ูู Debug Console:

```
๐ ุฌูุจ ุจูุงูุงุช ุงููุชุฌุฑ: ูุญูู ุนุจุฏูู ูุงุฑุน (vendor_123)
   - networkId: network_456
๐ฆ ุนุฏุฏ ุงููุนุงููุงุช: 5
   - ูุนุงููุฉ: type=charge, amount=100000.0
   - ูุนุงููุฉ: type=charge, amount=80000.0
   - ูุนุงููุฉ: type=payment, amount=-30000.0
   - ูุนุงููุฉ: type=charge, amount=50000.0
   - ูุนุงููุฉ: type=payment, amount=-25000.0
๐ฐ ุญุณุงุจ ุงูุฑุตูุฏ:
   - ุฅุฌูุงูู ุงููุณุชุญูุงุช: 230000.0
   - ุฅุฌูุงูู ุงููุฏููุนุงุช: 55000.0
   - ุงูุฑุตูุฏ ุงูุญุงูู: 175000.0
๐ ุงููุฎุฒูู ูู vendor_cards: 206 ูุฑุช
โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: balance=175000.0, stock=206
```

---

## ุงูุงุฎุชุจุงุฑ

### ุงูุณููุงุฑูู 1: ุนุฑุถ ุงูุฑุตูุฏ
1. ุณุฌูู ุฏุฎูู ุจุญุณุงุจ `networkOwner`
2. ุงุฐูุจ ุฅูู: ุงููุชุงุฌุฑ
3. ูุฌุจ ุฃู ุชุฑู ุงูุฑุตูุฏ ุงูุญุงูู ููู ูุชุฌุฑ ุจุฏูุฉ โ

### ุงูุณููุงุฑูู 2: ุชุญุฏูุซ ููุฑู ุนูุฏ ุทูุจ
1. ูุงุญุธ ุฑุตูุฏ ูุชุฌุฑ (ูุซูุงู: +100,000)
2. ูุงูู ุนูู ุทูุจ ุฌุฏูุฏ ูููุชุฌุฑ ุจูููุฉ 50,000
3. ูุฌุจ ุฃู ูุชุญุฏุซ ุงูุฑุตูุฏ ููุฑุงู โ +150,000 โ

### ุงูุณููุงุฑูู 3: ุชุญุฏูุซ ููุฑู ุนูุฏ ุฏูุนุฉ
1. ูุงุญุธ ุฑุตูุฏ ูุชุฌุฑ (+150,000)
2. ุงูุจู ุฏูุนุฉ ููุฏูุฉ ูู ุงููุชุฌุฑ ุจูููุฉ 50,000
3. ูุฌุจ ุฃู ูุชุญุฏุซ ุงูุฑุตูุฏ ููุฑุงู โ +100,000 โ

---

## ููุงุญุธุงุช ูููุฉ

### ุงููุฑู ุจูู ุงููุตุงุฏุฑ:
| ุงููุตุฏุฑ | ุงูุงุณุชุฎุฏุงู | ุงูุชุญุฏูุซ |
|--------|-----------|---------|
| `transactions` | โ ุญุณุงุจ ุงูุฑุตูุฏ (ุงูุญู ุงูุฌุฏูุฏ) | Real-time |
| `network_connections.balance` | โ ูููุฉ ุซุงุจุชุฉ (ุงููุฏูู) | ูุฏูู |
| `vendors.balance` | โ ูููุฉ ุซุงุจุชุฉ ูุฏููุฉ | ูุฏูู |

### ููุงุฐุง `transactions` ุฃูุถูุ
1. โ **Source of Truth**: ุงููุตุฏุฑ ุงูุฃุณุงุณู ูููุนุงููุงุช
2. โ **Always Accurate**: ูุนูุณ ุงููุถุน ุงููุนูู ุฏุงุฆูุงู
3. โ **Real-time**: ูุชุญุฏุซ ุชููุงุฆูุงู ุนูุฏ ุฃู ุชุบููุฑ
4. โ **Auditable**: ูููู ุชุชุจุน ูู ูุนุงููุฉ

---

## ุชุงุฑูุฎ ุงูุชุญุฏูุซ
**30 ุฃูุชูุจุฑ 2025** - ุชู ุชุทุจูู ุงูุฅุตูุงุญ ุจูุฌุงุญ

## ุงูุญุงูุฉ
โ **ุงูุฑุตูุฏ ูุธูุฑ ุงูุขู ุจุดูู ุตุญูุญ ูุฏููู**
โ **ูุชุฒุงูู ูุน ุงููุนุงููุงุช ุงููุนููุฉ**
โ **ูุชุญุฏุซ ูู ุงูููุช ุงููุนูู**

