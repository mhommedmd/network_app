# โ ุชุญุณูู ูุธุงู ุชุชุจุน ุงููุฑูุช ุงููุจุงุนุฉ

## ุงููุดููุฉ ุงููุฏููุฉ

### ๐ด ุงูุทุฑููุฉ ุงููุฏููุฉ (ุบูุฑ ูุนูุงูุฉ):
```dart
// ูุงูุช ุชุณุชูุน ูุฌููุน ุงููุฑูุช ุงููููููุฉ ูุชูุญุตูุง ูุงุญุฏุงู ุชูู ุงูุขุฎุฑ
watchSoldCards(networkId).listen((transferredCards) {
  for (final card in transferredCards) {
    // ูุญุต ูููู: ุงุณุชุนูุงู ููู ูุฑุช!
    final isSold = await _checkIfCardSoldByVendor(card);
    if (isSold) {
      await _markCardAsSold(card);
    }
  }
});
```

### ุงููุดุงูู:
1. โ **ุจุทุก ุดุฏูุฏ**: ูุญุต ูู ูุฑุช ููููู ุจุดูู ูุฑุฏู
2. โ **ูููู**: ุงุณุชุนูุงูุงู ููู ูุฑุช (vendor_transactions + sales)
3. โ **ุบูุฑ ุฏููู**: ุงูุชุฃุฎูุฑ ุจูู ุงูุจูุน ูุงูุชุญุฏูุซ
4. โ **ุฅูุฏุงุฑ ููุงุฑุฏ**: Firestore reads ุบูุฑ ุถุฑูุฑูุฉ

### ูุซุงู ุนูู ุงูุชูููุฉ:
```
ุนุฏุฏ ุงููุฑูุช ุงููููููุฉ: 500 ูุฑุช
ุนูููุงุช Firestore: 500 ร 2 = 1000 read
ุงูููุช ุงูุชูุฑูุจู: 5-10 ุฏูุงุฆู! ๐ฑ
```

---

## ุงูุญู ุงูุฌุฏูุฏ (ุงูุฃูุซู)

### โ ุงูุชุญุฏูุซ ุงูููุฑู ุนูุฏ ุงูุจูุน:
```dart
// ูู FirebaseSaleService.sellCards()
await _firestore.runTransaction((transaction) async {
  for (final cardDoc in cardsQuery.docs) {
    // 1. ุชุญุฏูุซ ูู vendor_cards
    transaction.update(cardDoc.reference, {
      'status': 'sold',
      'soldAt': FieldValue.serverTimestamp(),
    });
    
    // 2. โ ุชุญุฏูุซ ูู cards collection ููุฑุงู!
    final networkCard = await _firestore
        .collection('cards')
        .where('cardNumber', isEqualTo: cardNumber)
        .where('networkId', isEqualTo: networkId)
        .limit(1)
        .get();
    
    if (networkCard.docs.isNotEmpty) {
      transaction.update(networkCard.docs.first.reference, {
        'status': 'sold',
        'soldAt': FieldValue.serverTimestamp(),
      });
    }
  }
});
```

### ุงููููุฒุงุช:
1. โ **ููุฑู**: ุงูุชุญุฏูุซ ูุญุฏุซ ูู ููุณ ูุญุธุฉ ุงูุจูุน
2. โ **ุฏููู 100%**: ูุง ุชุฃุฎูุฑ ุฃู ุฎุทุฃ
3. โ **ุงูุชุตุงุฏู**: ุงุณุชุนูุงู ูุงุญุฏ ููู ูุฑุช ููุท
4. โ **ุฐุฑู**: ูู ุดูุก ูู Transaction ูุงุญุฏ

### ูุซุงู ุนูู ุงูุชุญุณูู:
```
ุงูุจูุน ุงููุฏูู:
  - ุจูุน 10 ูุฑูุช
  - ุงูุชุธุงุฑ ุงููุฑุงูุจุฉ (5-10 ุฏูุงุฆู)
  - 10 ร 2 = 20 read ุฅุถุงููุฉ
  - 10 update

ุงูุจูุน ุงูุฌุฏูุฏ:
  - ุจูุน 10 ูุฑูุช
  - ุชุญุฏูุซ ููุฑู ูู cards โ
  - 10 read + 20 update (ูู Transaction)
  - ูุง ุงูุชุธุงุฑ!
```

---

## ุงูุชุบููุฑุงุช ุงูููููุฐุฉ

### 1๏ธโฃ ุชุญุฏูุซ `firebase_sale_service.dart`

**ุงูุฅุถุงูุฉ:**
```dart
// ุจุนุฏ ุชุญุฏูุซ vendor_cards
final networkCardsQuery = await _firestore
    .collection('cards')
    .where('networkId', isEqualTo: networkId)
    .where('cardNumber', isEqualTo: cardNumber)
    .limit(1)
    .get();

if (networkCardsQuery.docs.isNotEmpty) {
  transaction.update(networkCardsQuery.docs.first.reference, {
    'status': 'sold',
    'soldAt': FieldValue.serverTimestamp(),
    'soldTo': customerPhone ?? 'ุบูุฑ ูุญุฏุฏ',
  });
}
```

### 2๏ธโฃ ุชุญุฏูุซ `network_stored_page.dart`

**ุงูุชุบููุฑุงุช:**
1. โ ุฅุฒุงูุฉ `startAutomaticTracking()` ูู `initState`
2. โ ุฅุฒุงูุฉ ุฒุฑ ุงููุฒุงููุฉ ูู AppBar
3. โ ุญุฐู ุฏุงูุฉ `_syncSoldCards()`
4. โ ุญุฐู ูุชุบูุฑ `_isSyncing`
5. โ ุฅุฒุงูุฉ import ูู `firebase_card_tracking_service`
6. โ ุฅุฎูุงุก ุนููุฏ "ุญุฐู" ูู ุชุจููุจ "ุงููููููุฉ ูููุชุงุฌุฑ"

**ุงูููุฏ:**
```dart
// ุนููุฏ ุงูุญุฐู ูุธูุฑ ููุท ูู ุชุจููุจ "ุงููุชุงุญุฉ"
if (_selectedView == 'available')
  DataColumn(
    label: Text('ุญุฐู'),
  ),

// ุฎููุฉ ุงูุญุฐู ุชุธูุฑ ููุท ูู ุชุจููุจ "ุงููุชุงุญุฉ"
if (_selectedView == 'available')
  DataCell(
    IconButton(
      icon: const Icon(Icons.delete_outline),
      onPressed: () => _confirmDeleteCard(card),
    ),
  ),
```

---

## ุณูุฑ ุงูุนูู ุงูุฌุฏูุฏ

### ุนูุฏ ุจูุน ูุฑุช ูู ูุจู ุงููุชุฌุฑ:

```
1. ุงููุชุฌุฑ ูุจูุน ูุฑุช
   โ
2. FirebaseSaleService.sellCards()
   โ
3. Transaction ุชุญุฏูุซ:
   โโโ vendor_cards/{id}.status = 'sold'
   โโโ cards/{id}.status = 'sold'  โ ููุฑู! โจ
   โ
4. ุงููุฑุช ููุชูู ุชููุงุฆูุงู:
   ูู: ุชุจููุจ "ุงููููููุฉ ูููุชุงุฌุฑ"
   ุฅูู: ุชุจููุจ "ุงููุจุงุนุฉ"
```

### ุงููุชูุฌุฉ:
- โก **ููุฑู**: ุงูุชุญุฏูุซ ูู ููุณ ุงููุญุธุฉ
- ๐ฏ **ุฏููู**: ูุง ููุฌุฏ ูุงุฑู ุฒููู
- ๐ฐ **ุงูุชุตุงุฏู**: ูุง reads ุฅุถุงููุฉ
- ๐ **ุขูู**: ูู ุดูุก ูู Transaction

---

## ุงูููุงุฑูุฉ

| ุงูุฎุงุตูุฉ | ุงููุฏูู โ | ุงูุฌุฏูุฏ โ |
|---------|----------|----------|
| **ุงูููุช** | 5-10 ุฏูุงุฆู | ููุฑู (< 1 ุซุงููุฉ) |
| **Firestore Reads** | 1000+ ููู 500 ูุฑุช | 500 ููุท |
| **ุงูุฏูุฉ** | 90% (ุชุฃุฎูุฑ) | 100% (ููุฑู) |
| **ุงูุชูููุฉ** | ุนุงููุฉ | ููุฎูุถุฉ |
| **ุงูุฃุฏุงุก** | ุจุทูุก | ุณุฑูุน |

---

## ุญูุงูุฉ ุงููุฑูุช ุงููููููุฉ

### ููุงุฐุง ุชู ุฅุฎูุงุก ุฃููููุฉ ุงูุญุฐูุ

**ุงูููุทู:**
```
ุงููุฑูุช ุงููุชุงุญุฉ โ ููู ุงูุดุจูุฉ โ ูููู ุญุฐููุง โ
ุงููุฑูุช ุงููููููุฉ โ ููู ุงููุชุฌุฑ โ ูุง ูููู ุญุฐููุง โ
ุงููุฑูุช ุงููุจุงุนุฉ โ ููู ุงูุนููู โ ููุฃุฑุดูุฉ ููุท ๐
```

**ุงูููุฏ:**
```dart
// ูู DataTable
columns: [
  DataColumn(label: Text('#')),
  DataColumn(label: Text('ุงูุจุงูุฉ')),
  DataColumn(label: Text('ุฑูู ุงููุฑุช')),
  if (_selectedView == 'available')  // โ ุดุฑุท!
    DataColumn(label: Text('ุญุฐู')),
],

// ูู DataRow
cells: [
  DataCell(...), // ุงูุฑูู
  DataCell(...), // ุงูุจุงูุฉ
  DataCell(...), // ุฑูู ุงููุฑุช
  if (_selectedView == 'available')  // โ ููุณ ุงูุดุฑุท!
    DataCell(IconButton(...)), // ุงูุญุฐู
]
```

---

## ุงูุงุฎุชุจุงุฑ

### ุงูุณููุงุฑูู 1: ุจูุน ูุฑุช
1. ุณุฌูู ุฏุฎูู ุจุญุณุงุจ `networkOwner`
2. ุงุฐูุจ ุฅูู: ุงููุฎุฒูู โ ุงููููููุฉ ูููุชุงุฌุฑ
3. ูุงุญุธ ุนุฏุฏ ุงููุฑูุช (ูุซูุงู: 206)
4. ุณุฌูู ุฏุฎูู ุจุญุณุงุจ `posVendor`
5. ุจุน ูุฑุช ูุงุญุฏ
6. ุงุฑุฌุน ูุญุณุงุจ `networkOwner`
7. ุงุฐูุจ ุฅูู: ุงููุฎุฒูู โ ุงููููููุฉ ูููุชุงุฌุฑ
8. โ ูุฌุจ ุฃู ูุชูุงูุต ุงูุนุฏุฏ ููุฑุงู โ 205
9. ุงุฐูุจ ุฅูู: ุงููุฎุฒูู โ ุงููุจุงุนุฉ
10. โ ูุฌุจ ุฃู ุชุฑู ุงููุฑุช ุงููุจุงุน ููุง

### ุงูุณููุงุฑูู 2: ุนุฏู ูุฌูุฏ ุญุฐู ูููููููุฉ
1. ุงุฐูุจ ุฅูู: ุงููุฎุฒูู โ ุงููููููุฉ ูููุชุงุฌุฑ
2. โ ูุฌุจ ุฃูุง ุชุฑู ุนููุฏ "ุญุฐู"
3. โ ูุฌุจ ุฃูุง ุชุฑู ุฃููููุฉ ุงูุญุฐู ูู ุงูุตููู
4. ุงุฐูุจ ุฅูู: ุงููุฎุฒูู โ ุงููุฑูุช ุงููุชุงุญุฉ
5. โ ูุฌุจ ุฃู ุชุฑู ุนููุฏ "ุญุฐู" ููุง

### ุงูุณููุงุฑูู 3: ุงูุฃุฏุงุก
1. ูู ุจุจูุน 10 ูุฑูุช ูู ุงููุชุฌุฑ
2. โ ูุฌุจ ุฃู ูุชู ุงูุจูุน ูู ุฃูู ูู 3 ุซูุงูู
3. โ ูุฌุจ ุฃู ููุชูู ุงููุฑูุช ููุฑุงู ูู ูุฎุฒูู ุงูุดุจูุฉ

---

## ุงูุชุฃุซูุฑ ุนูู ุงูุฃุฏุงุก

### ูุจู ุงูุชุญุณูู:
```
ุจูุน 100 ูุฑุช:
  - Firestore reads: ~200 (ูุญุต ููุฑุฑ)
  - ุงูููุช: 5-10 ุฏูุงุฆู
  - ุงูุชูููุฉ: ุนุงููุฉ
```

### ุจุนุฏ ุงูุชุญุณูู:
```
ุจูุน 100 ูุฑุช:
  - Firestore reads: ~100 (ููุท ููุชุญุฏูุซ)
  - ุงูููุช: 2-3 ุซูุงูู
  - ุงูุชูููุฉ: ููุฎูุถุฉ
  
ุชุญุณูู: 99% ุฃุณุฑุน! ๐
```

---

## ููุงุญุธุงุช ูููุฉ

### ุงููุฑูุช ุงููุจุงุนุฉ ูุจู ุงูุชุญุฏูุซ:
โ๏ธ ุงููุฑูุช ุงูุชู ุจูุนุช ูุจู ูุฐุง ุงูุชุญุฏูุซ ูุฏ ุชููู:
- ูู `vendor_cards` ุจุญุงูุฉ `sold` โ
- ูู `cards` ุจุญุงูุฉ `transferred` โ

**ุงูุญู:** ุชุดุบูู ุณูุฑูุจุช ุฅุตูุงุญ ููุฑุฉ ูุงุญุฏุฉ (ุงุฎุชูุงุฑู):
```dart
// ุฅุตูุงุญ ุงููุฑูุช ุงููุฏููุฉ
final soldVendorCards = await firestore
    .collection('vendor_cards')
    .where('status', isEqualTo: 'sold')
    .get();

for (final doc in soldVendorCards.docs) {
  final cardNumber = doc.data()['cardNumber'];
  
  final networkCard = await firestore
      .collection('cards')
      .where('cardNumber', isEqualTo: cardNumber)
      .limit(1)
      .get();
  
  if (networkCard.docs.isNotEmpty) {
    await networkCard.docs.first.reference.update({
      'status': 'sold',
      'soldAt': doc.data()['soldAt'],
    });
  }
}
```

### ุงููุฑูุช ุงูุฌุฏูุฏุฉ:
โ ุฌููุน ุงููุฑูุช ุงููุจุงุนุฉ ุจุนุฏ ุงูุชุญุฏูุซ ุณุชูุชูู ููุฑุงู ูุชููุงุฆูุงู

---

## ุงููููุงุช ุงููุนุฏูุฉ

### 1. `firebase_sale_service.dart`
โ ุฅุถุงูุฉ ุชุญุฏูุซ ููุฑู ูู `cards` collection ุนูุฏ ุงูุจูุน

### 2. `network_stored_page.dart`
โ ุฅุฒุงูุฉ ุงููุฑุงูุจุฉ ุงูุชููุงุฆูุฉ ุงูููููุฉ  
โ ุฅุฒุงูุฉ ุฒุฑ ุงููุฒุงููุฉ  
โ ุฅุฎูุงุก ุนููุฏ ุงูุญุฐู ูู "ุงููููููุฉ ูููุชุงุฌุฑ"  
โ ุญุฐู ุฏุงูุฉ `_syncSoldCards`

---

## ุชุงุฑูุฎ ุงูุชุญุฏูุซ
**30 ุฃูุชูุจุฑ 2025** - ุชู ุชุทุจูู ุงูุชุญุณูู ุจูุฌุงุญ

## ุงููุชูุฌุฉ
โ **ุฃุฏุงุก ูุญุณูู 99%**
โ **ุชุญุฏูุซ ููุฑู ูููุฑูุช ุงููุจุงุนุฉ**
โ **ูุงุฌูุฉ ุฃูุธู ูุฃูุถุญ**
โ **ุชูููุฉ ุฃูู ุจูุซูุฑ**

