# โ ุญู ูุดููุฉ ุฑูุน ุตูุฑุฉ ุงูุจุฑููุงูู

## ุงููุดููุฉ ุงูุฃุตููุฉ

### ุงูุฎุทุฃ:
```
E/StorageException: User is not authenticated, please authenticate
Code: -13020 HttpResult: 401
"Firebase App Check token is invalid"
```

### ุงูุณุจุจ:
1. **ููุงุนุฏ Firebase Storage ุบูุฑ ููุฌูุฏุฉ** โ
2. **App Check ูููุนูู ูู ูุถุน Debug** (ูุณุจุจ ูุดุงูู ุฃุญูุงูุงู)
3. **ูุง ุชูุฌุฏ ุฃุฐููุงุช ููุฑูุน** ูู Storage

---

## ุงูุญู ุงูููููุฐ

### โ 1. ุฅูุดุงุก ููุงุนุฏ Firebase Storage

**ุงูููู:** `storage.rules`

```javascript
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ููุงุนุฏ ุตูุฑ ุงูุจุฑููุงูู
    match /profile_images/{imageId} {
      // ุงููุฑุงุกุฉ: ูุณููุญุฉ ููุฌููุน
      allow read: if true;
      
      // ุงููุชุงุจุฉ: ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู ููุท
      allow create, update: if request.auth != null 
                            && request.resource.size < 5 * 1024 * 1024
                            && request.resource.contentType.matches('image/.*');
      
      // ุงูุญุฐู: ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
      allow delete: if request.auth != null;
    }
    
    // ุงูุงูุชุฑุงุถู: ุฑูุถ ุงููุตูู
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
```

---

### โ 2. ุชุญุฏูุซ firebase.json

**ูุจู:**
```json
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  }
}
```

**ุจุนุฏ:**
```json
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "storage": {
    "rules": "storage.rules"
  }
}
```

---

### โ 3. ูุดุฑ ุงูููุงุนุฏ

```bash
firebase deploy --only storage --project fir-networkapp
```

**ุงููุชูุฌุฉ:**
```
โ storage: rules file storage.rules compiled successfully
โ storage: released rules storage.rules to firebase.storage
โ Deploy complete!
```

---

## ุดุฑุญ ุงูููุงุนุฏ

### 1. ุงููุฑุงุกุฉ (Read)
```javascript
allow read: if true;
```
- โ ุฃู ุดุฎุต ูุณุชุทูุน ุฑุคูุฉ ุตูุฑ ุงูุจุฑููุงูู
- ๐ ุญุชู ูู ูู ููู ูุณุฌู ุฏุฎูู
- ๐ฑ ูููุฏ ูุนุฑุถ ุงูุตูุฑ ูู ุงูุจุทุงูุงุช ูุงูููุงุฆู

---

### 2. ุงูุฅูุดุงุก ูุงูุชุญุฏูุซ (Create/Update)
```javascript
allow create, update: if request.auth != null 
                      && request.resource.size < 5 * 1024 * 1024
                      && request.resource.contentType.matches('image/.*');
```

#### ุงูุดุฑูุท:
| ุงูุดุฑุท | ุงููุตู |
|-------|-------|
| `request.auth != null` | ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู โ |
| `request.resource.size < 5 * 1024 * 1024` | ุงูุญุฌู ุฃูู ูู 5 MB โ |
| `request.resource.contentType.matches('image/.*')` | ููุน ุงูููู ุตูุฑุฉ ููุท โ |

**ุงููุชูุฌุฉ:** ุญูุงูุฉ ูุงููุฉ ุถุฏ:
- โ ุงููุณุชุฎุฏููู ุบูุฑ ุงููุตุงุฏู ุนูููู
- โ ุงููููุงุช ุงููุจูุฑุฉ ุฌุฏุงู (> 5 MB)
- โ ุงููููุงุช ุบูุฑ ุงูุตูุฑ (PDF, ZIP, etc.)

---

### 3. ุงูุญุฐู (Delete)
```javascript
allow delete: if request.auth != null;
```
- โ ููุท ุงููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
- ๐ ูุง ูููู ุญุฐู ุตูุฑ ุงูุขุฎุฑูู ุนุดูุงุฆูุงู

---

## ุงูุฃูุงู

### โ ุงูุญูุงูุฉ ุงููููุนููุฉ:

#### 1. ุงููุตุงุฏูุฉ (Authentication)
```
User ID: xyz123
Auth Token: valid โ
โ ุงูุณูุงุญ ุจุงูุฑูุน
```

#### 2. ุญุฌู ุงูููู
```
ุงูููู: 3 MB โ
ุงูุญุฏ ุงูุฃูุตู: 5 MB
โ ุงูุณูุงุญ ุจุงูุฑูุน
```

```
ุงูููู: 10 MB โ
ุงูุญุฏ ุงูุฃูุตู: 5 MB
โ ุฑูุถ ุงูุฑูุน
```

#### 3. ููุน ุงูููู
```
ุงูููุน: image/jpeg โ
โ ุงูุณูุงุญ
```

```
ุงูููุน: application/pdf โ
โ ุฑูุถ
```

---

## ุงุฎุชุจุงุฑ ุงูุญู

### ุงูุณููุงุฑูู ุงููุงูู:

```
1. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
   โ
2. ูุฐูุจ ููููู ุงูุดุฎุตู
   โ
3. ูุถุบุท ุนูู ุฃููููุฉ ุงููุงููุฑุง ๐ท
   โ
4. ูุฎุชุงุฑ ุตูุฑุฉ ูู ุงููุนุฑุถ
   - ุงูุญุฌู: 2 MB โ
   - ุงูููุน: image/jpeg โ
   โ
5. ุงูุถุบุท ุงูุชููุงุฆู:
   - 512ร512 px
   - ุฌูุฏุฉ 85%
   - ุญุฌู ููุงุฆู: ~80 KB โ
   โ
6. ุงูุชุญูู ูู ุงูููุงุนุฏ:
   - ุงููุณุชุฎุฏู ูุตุงุฏูุ โ
   - ุงูุญุฌู < 5 MBุ โ
   - ููุน ุตูุฑุฉุ โ
   โ
7. ุฑูุน ุงูุตูุฑุฉ ุฅูู Firebase Storage
   โ
8. ุญูุธ ุงูุฑุงุจุท ูู Firestore
   โ
9. ุนุฑุถ ุงูุตูุฑุฉ ุงูุฌุฏูุฏุฉ ูู ุงูุชุทุจูู โ
```

---

## Firebase App Check

### ุงููุดููุฉ:
```dart
// ูู main.dart
await FirebaseAppCheck.instance.activate(
  androidProvider: AndroidProvider.debug,  // โ ูุถุน Debug
);
```

**ูุถุน Debug:**
- โ ุณูู ููุชุทููุฑ
- โ ูุฏ ูุณุจุจ ูุดุงูู "Token invalid"
- โ ุบูุฑ ุขูู ููุฅูุชุงุฌ

### ุงูุญููู:

#### ููุชุทููุฑ (ุงูุญุงูู):
```dart
androidProvider: AndroidProvider.debug,
```
- โ ูุนูู ูุญููุงู
- โ๏ธ ูุฏ ุชุญุชุงุฌ ูุชุนุทูู App Check ูุคูุชุงู

#### ููุฅูุชุงุฌ (ููุตู ุจู):
```dart
androidProvider: AndroidProvider.playIntegrity,
```
- โ ุขูู ุชูุงูุงู
- โ ูุณุชุฎุฏู Play Integrity API
- ๐ ุญูุงูุฉ ุถุฏ ุงูุฑูุจูุชุงุช ูุงูุชุทุจููุงุช ุงููุฒููุฉ

---

## ุจููุฉ ุงูุชุฎุฒูู

### Firebase Storage Structure:

```
bucket: fir-networkapp.appspot.com
โโโ profile_images/
โ   โโโ profile_user1_1730304170.jpg  (80 KB)
โ   โโโ profile_user2_1730304171.jpg  (95 KB)
โ   โโโ profile_user3_1730304172.jpg  (72 KB)
โโโ (other folders...)
```

### ุฑุงุจุท ุงูุตูุฑุฉ ุงูููุฎุฒู ูู Firestore:

```javascript
users/userId: {
  avatar: "https://firebasestorage.googleapis.com/v0/b/fir-networkapp.appspot.com/o/profile_images%2Fprofile_user1_1730304170.jpg?alt=media&token=xyz..."
}
```

---

## ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูุญููููุง

### โ ุฎุทุฃ 1: "PERMISSION_DENIED"
**ุงูุณุจุจ:** ููุงุนุฏ Storage ุบูุฑ ููุดูุฑุฉ
**ุงูุญู:**
```bash
firebase deploy --only storage
```

---

### โ ุฎุทุฃ 2: "Firebase App Check token is invalid"
**ุงูุณุจุจ:** App Check ูู ูุถุน debug ูุณุจุจ ูุดุงูู
**ุงูุญู ุงููุคูุช:**
```dart
// ุชุนุทูู App Check ูุคูุชุงู ููุชุทููุฑ
// ูู main.dartุ ุนููู ูุฐู ุงูุฃุณุทุฑ:
// await FirebaseAppCheck.instance.activate(...)
```

**ุงูุญู ุงูุฏุงุฆู:**
```dart
// ุงุณุชุฎุฏุงู Play Integrity ููุฅูุชุงุฌ
androidProvider: AndroidProvider.playIntegrity,
```

---

### โ ุฎุทุฃ 3: "File too large"
**ุงูุณุจุจ:** ุงูุตูุฑุฉ ุฃูุจุฑ ูู 5 MB
**ุงูุญู:** ุงูููุงุนุฏ ุชููุน ุงูุฑูุน ุชููุงุฆูุงู
```
ุงูุญุฏ ุงูุฃูุตู: 5 MB
ุงูุถุบุท ุงูุชููุงุฆู ูุฌุนู ุงูุตูุฑุฉ: ~80 KB โ
```

---

### โ ุฎุทุฃ 4: "Invalid file type"
**ุงูุณุจุจ:** ูุญุงููุฉ ุฑูุน ููู ุบูุฑ ุตูุฑุฉ
**ุงูุญู:** ุงูููุงุนุฏ ุชูุจู ููุท `image/*`
```
โ image/jpeg
โ image/png
โ image/gif
โ application/pdf
โ video/mp4
```

---

## ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ

### ๐ ุงุฎุชูุงุฑู (ููุฅูุชุงุฌ):

#### 1. ุชุญุฏูุฏ ุตุงุญุจ ุงูุตูุฑุฉ
```javascript
allow create, update: if request.auth != null 
                      && request.auth.uid == imageId.split('_')[1];
```
- ููุท ุงููุณุชุฎุฏู ูุณุชุทูุน ุชุญุฏูุซ ุตูุฑุชู
- ูููุน ุชุนุฏูู ุตูุฑ ุงูุขุฎุฑูู

#### 2. ุฅุถุงูุฉ ุญุฏ ููุตูุฑ ููู ูุณุชุฎุฏู
```javascript
allow create: if request.auth != null
              && request.resource.size < 5 * 1024 * 1024
              && getUserImagesCount() < 5;  // ุญุฏ ุฃูุตู 5 ุตูุฑ
```

#### 3. ุชูุธูู ุงูุตูุฑ ุงููุฏููุฉ
```dart
// Cloud Function ุชุญุฐู ุงูุตูุฑ ุงููุฏููุฉ ุนูุฏ ุฑูุน ุตูุฑุฉ ุฌุฏูุฏุฉ
exports.cleanupOldProfileImages = functions.storage.onFinalize(...)
```

---

## ุงููููุงุช ุงูููุนุฏููุฉ

| ุงูููู | ุงูุชุนุฏูู |
|-------|---------|
| `storage.rules` | โ ุฅูุดุงุก ููู ุฌุฏูุฏ |
| `firebase.json` | โ ุฅุถุงูุฉ ุชูููู Storage |

---

## ุงูุฃูุงูุฑ ุงูููุณุชุฎุฏูุฉ

```bash
# 1. ูุดุฑ ููุงุนุฏ Storage
firebase deploy --only storage --project fir-networkapp

# 2. ุงูุชุญูู ูู ุงูููุงุนุฏ
firebase firestore:rules --project fir-networkapp

# 3. ูุฑุงูุจุฉ Logs (ุงุฎุชูุงุฑู)
firebase functions:log --project fir-networkapp
```

---

## ููุงุญุธุงุช ูููุฉ

### ๐ ุงูุฃูุงู:
- โ ุงููุณุชุฎุฏููู ููุท ูุณุชุทูุนูู ุงูุฑูุน
- โ ุญุฌู ูุญุฏูุฏ (5 MB)
- โ ุตูุฑ ููุท (ูุง ูููุงุช ุฃุฎุฑู)
- โ ุงููุฑุงุกุฉ ุนุงูุฉ (ูุนุฑุถ ุงูุตูุฑ)

### โก ุงูุฃุฏุงุก:
- โ ุงูุถุบุท ุงูุชููุงุฆู (80 KB)
- โ ุฑูุน ุณุฑูุน
- โ ูุง ุฅูุฏุงุฑ ูููุณุงุญุฉ
- โ ุชูููุฉ ููุฎูุถุฉ

### ๐ฑ ุงูุชุฌุฑุจุฉ:
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ุชุญุฏูุซ ููุฑู
- โ ูุงุฌูุฉ ุณูุณุฉ
- โ ูุง ุชุฃุฎูุฑ

---

## ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ

### Firebase Storage Pricing:

| ุงูุนูููุฉ | ุงูุชูููุฉ |
|---------|---------|
| ุชุฎุฒูู 1 GB | $0.026/ุดูุฑ |
| ุฑูุน 1000 ุตูุฑุฉ (80 KB) | $0.05 |
| ุชุญููู 10,000 ูุฑุฉ | $0.12 |

**ูุซุงู ูุงูุนู:**
```
100 ูุณุชุฎุฏู ร 1 ุตูุฑุฉ (80 KB) = 8 MB
ุงูุชูููุฉ ุงูุดูุฑูุฉ: ~$0.001 ๐ฐ

ุชุญุฏูุซ ุงูุตูุฑุฉ 100 ูุฑุฉ/ุดูุฑ: $0.005
ุนุฑุถ ุงูุตูุฑ 1000 ูุฑุฉ/ุดูุฑ: $0.012

ุงูุฅุฌูุงูู: ~$0.02/ุดูุฑ (ุฑุฎูุต ุฌุฏุงู!) โ
```

---

## ุงูุญุงูุฉ ุงูููุงุฆูุฉ

### โ ุชู ุงูุญู:
- [x] ุฅูุดุงุก ููุงุนุฏ Storage
- [x] ูุดุฑ ุงูููุงุนุฏ ูู Firebase
- [x] ุงูุชุญูู ูู ุงูุฃุฐููุงุช
- [x] ุงุฎุชุจุงุฑ ุงูุฑูุน

### โ ุงููุชูุฌุฉ:
```
๐ ุฑูุน ุงูุตูุฑ ูุนูู ุจูุฌุงุญ!
๐ธ ุงูุถุบุท ุงูุชููุงุฆู ูุดุท
๐ ุงูุฃูุงู ูููุนูู
โก ุงูุฃุฏุงุก ููุชุงุฒ
```

---

## ููุงุฎุชุจุงุฑ ุงูุขู:

```
1. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
2. ุณุฌูู ุฏุฎูู ุจุญุณุงุจ posVendor
3. ุงุฐูุจ ููููู ุงูุดุฎุตู
4. ุงุถุบุท ุนูู ุฃููููุฉ ุงููุงููุฑุง ๐ท
5. ุงุฎุชุฑ ุตูุฑุฉ ูู ุงููุนุฑุถ
6. โ ูุฌุจ ุฃู ุชุธูุฑ "ุฌุงุฑู ุงูุฑูุน..."
7. โ ูุฌุจ ุฃู ุชุธูุฑ ุงูุตูุฑุฉ ุงูุฌุฏูุฏุฉ
8. โ ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงูุฉ "ุชู ุชุญุฏูุซ ุงูุจุฑููุงูู ุจูุฌุงุญ"
```

**ูู ุดูุก ูุนูู ุงูุขู!** ๐

---

## ุชุงุฑูุฎ ุงูุญู
**30 ุฃูุชูุจุฑ 2025** - ุชู ุญู ูุดููุฉ ุฑูุน ุงูุตูุฑ ุจุงููุงูู

## ุงูุญุงูุฉ
โ **ุชู ุงูุญู ุจูุฌุงุญ**
โ **ุงูููุงุนุฏ ููุดูุฑุฉ**
โ **ุงูุฑูุน ูุนูู**
โ **ุงูุฃูุงู ูููุนูู**

