# 📦 نظام الباقات والكروت المتكامل

## 🎯 نظرة عامة

تم تطوير نظام متكامل لإدارة الباقات والكروت مع Firebase، يضمن:
- ✅ **لا توجد بيانات تجريبية** - صفحة نظيفة تماماً
- ✅ **حفظ تلقائي في Firebase** عند إضافة باقات أو كروت
- ✅ **ربط محكم** بين الباقات والكروت
- ✅ **منع استيراد كروت** بدون وجود باقات مسبقاً
- ✅ **تحديث تلقائي للمخزون** عند استيراد الكروت

---

## 🔄 سير العمل الصحيح

### المرحلة 1️⃣: إضافة الباقات

```
┌─────────────────────────────────────┐
│  1. مالك الشبكة يسجل الدخول        │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  2. يذهب إلى تبويب "الباقات"       │
│     (في البداية: لا توجد باقات)    │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  3. يضغط "إضافة باقة"              │
│     • اسم الباقة: "باقة 10 أيام"   │
│     • السعر: 1000 ر.ي              │
│     • الصلاحية: 10 أيام            │
│     • البيانات: 5 جيجا              │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  ✅ يتم الحفظ في Firebase تلقائياً │
│  ✅ تظهر الباقة في القائمة فوراً   │
└─────────────────────────────────────┘
```

### المرحلة 2️⃣: استيراد الكروت

```
┌─────────────────────────────────────┐
│  1. يضغط "استيراد كروت"            │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  2. يختار الباقة من القائمة        │
│     (مثال: باقة 10 أيام)           │
│     ⚠️ إذا لم توجد باقات:          │
│     "يجب إضافة باقة أولاً!"        │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  3. يختار ملف الكروت               │
│     (Excel, CSV, PDF)              │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  4. يتم استخراج أرقام الكروت       │
│     والتحقق من عدم التكرار         │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  5. يضغط "إضافة الكروت"            │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  ✅ يحفظ في Firebase:               │
│     • رقم الكرت                     │
│     • PIN عشوائي                   │
│     • معرف الباقة (packageId)      │
│     • السعر من الباقة              │
│     • الصلاحية من الباقة           │
│     • الحالة: متاح                 │
│  ✅ يزيد المخزون في الباقة        │
└─────────────────────────────────────┘
```

### المرحلة 3️⃣: عرض المخزون

```
┌─────────────────────────────────────┐
│  يفتح صفحة "المخزون"               │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  📊 إحصائيات من Firebase:          │
│     • الإجمالي: 500 كرت            │
│     • متاح: 480                    │
│     • مباع: 20                     │
│  🎯 فلترة:                          │
│     • حسب الباقة                   │
│     • حسب الحالة                   │
│  📋 عرض تفصيلي:                    │
│     • رقم الكرت + PIN              │
│     • السعر + الصلاحية             │
│     • الحالة بالألوان              │
└─────────────────────────────────────┘
```

---

## 🏗️ البنية التقنية المحدثة

### 1. **الباقات (Packages)**

```
Firebase Collection: "packages"
└── package_id_1
    ├── name: "باقة 10 أيام"
    ├── mikrotikName: "10day-package"
    ├── sellingPrice: 1000
    ├── purchasePrice: 700
    ├── validityDays: 10
    ├── usageHours: 240
    ├── dataSizeGB: 5
    ├── stock: 500  ← يتم تحديثه تلقائياً عند استيراد الكروت
    ├── networkId: "owner_id"
    ├── createdBy: "owner_id"
    ├── createdAt: timestamp
    └── isActive: true
```

### 2. **الكروت (Cards)**

```
Firebase Collection: "cards"
└── card_id_1
    ├── cardNumber: "123456789"
    ├── pin: "4521"
    ├── packageId: "package_id_1"  ← ربط مع الباقة
    ├── packageName: "باقة 10 أيام"
    ├── price: 1000  ← من معلومات الباقة
    ├── expiryDate: "2025-11-04"  ← حسب validityDays للباقة
    ├── status: "available"
    ├── networkId: "owner_id"
    ├── createdBy: "owner_id"
    └── notes: "تم الاستيراد من file.xlsx"
```

---

## ✅ ما تم إنجازه

### 1. **إزالة البيانات التجريبية**
- ✅ حُذفت جميع الباقات التجريبية من `network_page.dart`
- ✅ الصفحة تبدأ نظيفة تماماً
- ✅ رسالة واضحة: "لا توجد باقات - ابدأ بإضافة أول باقة"

### 2. **حفظ الباقات في Firebase**
- ✅ `AddPackagePage` تحفظ في Firebase تلقائياً
- ✅ استخدام `PackageProvider` لإدارة الحالة
- ✅ تحويل اللون والأيقونة للتنسيق الصحيح
- ✅ رسائل نجاح/فشل واضحة

### 3. **عرض الباقات من Firebase**
- ✅ `NetworkPage` تعرض الباقات من Firebase مباشرة
- ✅ تحديث تلقائي عند إضافة باقات جديدة
- ✅ مزامنة حية (Real-time sync)

### 4. **ربط الكروت بالباقات**
- ✅ لا يمكن استيراد كروت بدون باقات
- ✅ رسالة تحذير واضحة: "يجب إضافة باقة أولاً!"
- ✅ كل كرت يُحفظ مع:
  - `packageId` - معرف الباقة الفعلي
  - `price` - من سعر الباقة
  - `expiryDate` - حسب صلاحية الباقة
  - `packageName` - للعرض

### 5. **تحديث المخزون التلقائي**
- ✅ عند استيراد 100 كرت لباقة معينة
- ✅ يزداد `stock` الباقة بـ 100 تلقائياً
- ✅ التحديث في Firebase مباشرة

---

## 📝 الملفات المُحدثة

| الملف | التحديثات |
|-------|-----------|
| `add_package_page.dart` | ✅ حفظ في Firebase عبر PackageProvider |
| `network_page.dart` | ✅ إزالة البيانات التجريبية، عرض من Firebase |
| `import_cards_page.dart` | ✅ التحقق من وجود باقات، ربط الكروت بالباقة، تحديث المخزون |
| `network_stored_page.dart` | ✅ عرض من Firebase فقط (تم سابقاً) |

---

## 🎨 واجهة المستخدم

### صفحة الباقات (NetworkPage)

#### عند عدم وجود باقات:
```
┌─────────────────────────────────────┐
│           الباقات                   │
├─────────────────────────────────────┤
│                                     │
│         📭                          │
│     لا توجد باقات                  │
│  ابدأ بإضافة أول باقة               │
│                                     │
│  [+ إضافة باقة]  [⬆️ استيراد كروت] │
└─────────────────────────────────────┘
```

#### بعد إضافة باقات:
```
┌─────────────────────────────────────┐
│  ✅ تم إضافة الباقة: باقة 10 أيام  │
├─────────────────────────────────────┤
│  📦 باقة 10 أيام                   │
│  💰 1,000 ر.ي                      │
│  📅 10 يوم | 📊 500 كرت متاح       │
│  [تعديل]                           │
├─────────────────────────────────────┤
│  📦 باقة شهرية                     │
│  💰 3,000 ر.ي                      │
│  📅 30 يوم | 📊 200 كرت متاح       │
└─────────────────────────────────────┘
```

### صفحة استيراد الكروت

#### بدون باقات:
```
┌─────────────────────────────────────┐
│  نوع الباقة                         │
├─────────────────────────────────────┤
│  ⚠️ لا توجد باقات!                │
│  يجب إضافة باقة أولاً قبل استيراد │
│  الكروت                             │
└─────────────────────────────────────┘
```

#### مع باقات:
```
┌─────────────────────────────────────┐
│  نوع الباقة                         │
│  [باقة 10 أيام (500 كرت متاح) ▼]  │
├─────────────────────────────────────┤
│  عدد أرقام الكرت                   │
│  [9]                                │
├─────────────────────────────────────┤
│  [📁 اختيار ملف]                   │
└─────────────────────────────────────┘
```

---

## 🔥 العلاقة بين الباقات والكروت

### المثال العملي:

#### 1. إضافة باقة "10 أيام":
```javascript
{
  id: "pkg_001",
  name: "باقة 10 أيام",
  sellingPrice: 1000,
  validityDays: 10,
  stock: 0  // صفر في البداية
}
```

#### 2. استيراد 100 كرت لهذه الباقة:
```javascript
// كل كرت يُحفظ بهذا الشكل:
{
  id: "card_001",
  cardNumber: "123456789",
  packageId: "pkg_001",  // مرتبط بالباقة
  packageName: "باقة 10 أيام",
  price: 1000,  // من سعر الباقة
  expiryDate: "2025-11-04",  // اليوم + 10 أيام
  status: "available"
}

// وتلقائياً يتم تحديث الباقة:
{
  id: "pkg_001",
  stock: 100  // ← زاد من 0 إلى 100
}
```

#### 3. بيع كرت:
```javascript
// يتم تحديث حالة الكرت:
{
  status: "sold",
  soldTo: "customer_id",
  soldAt: "2025-10-25T10:30:00Z"
}

// ويقل المخزون:
{
  stock: 99  // ← نقص من 100 إلى 99
}
```

---

## 📊 الفوائد الرئيسية

### 1. **بيانات دقيقة ومتسقة**
- الكروت دائماً مرتبطة بباقة موجودة
- السعر والصلاحية تأتي من الباقة
- لا يمكن وجود كروت "يتيمة"

### 2. **سهولة التتبع**
```sql
-- كم كرت لدي من باقة 10 أيام؟
SELECT COUNT(*) FROM cards 
WHERE packageId = 'pkg_001' 
  AND status = 'available'

-- كم باقة لدي مخزون فيها أقل من 50 كرت؟
SELECT * FROM packages 
WHERE stock < 50
```

### 3. **تقارير دقيقة**
- إجمالي قيمة المخزون لكل باقة
- الباقات الأكثر مبيعاً
- الكروت القريبة من الانتهاء

### 4. **منع الأخطاء**
- ❌ لا يمكن استيراد كروت بدون باقة
- ❌ لا يمكن حذف باقة لها كروت نشطة
- ❌ لا يمكن تكرار أرقام الكروت

---

## 🚀 حالات الاستخدام

### حالة 1: بدء جديد
```
المستخدم → تسجيل دخول → صفحة الباقات: "لا توجد باقات"
         → إضافة باقة → ✅ محفوظة في Firebase
         → استيراد كروت → يختار الباقة → ✅ محفوظة في Firebase
```

### حالة 2: عرض المخزون
```
المستخدم → المخزون → يرى:
           • إحصائيات شاملة
           • فلترة حسب الباقة
           • فلترة حسب الحالة
           • كل كرت مع تفاصيله الكاملة
```

### حالة 3: إدارة المخزون
```
المستخدم → يستورد 100 كرت "باقة 10 أيام"
         → stock الباقة يزيد تلقائياً من 0 → 100
         → يبيع 20 كرت
         → stock الباقة ينقص إلى 80
```

---

## 🔧 التحسينات المطبقة

### في `add_package_page.dart`:
```dart
✅ استخدام PackageProvider
✅ إنشاء PackageModel بكامل البيانات
✅ حفظ في Firebase تلقائياً
✅ معالجة الأخطاء مع رسائل واضحة
✅ مؤشر تحميل أثناء الحفظ
```

### في `network_page.dart`:
```dart
✅ حذف جميع البيانات التجريبية (samplePackages)
✅ تحميل الباقات من Firebase عبر PackageProvider
✅ عرض رسالة "لا توجد باقات" عند البداية
✅ مزامنة تلقائية مع Firebase (Stream)
```

### في `import_cards_page.dart`:
```dart
✅ التحقق من وجود باقات قبل السماح بالاستيراد
✅ عرض تحذير واضح إذا لم توجد باقات
✅ استخدام معرف الباقة الفعلي (packageId)
✅ الحصول على السعر من الباقة المحددة
✅ حساب الصلاحية من validityDays للباقة
✅ تحديث stock الباقة تلقائياً بعد الاستيراد
✅ عرض المخزون المتاح بجانب كل باقة
```

### في `network_stored_page.dart`:
```dart
✅ عرض الكروت من Firebase فقط
✅ فلترة حسب الباقة والحالة
✅ إحصائيات شاملة
```

---

## 🎯 مثال عملي كامل

### السيناريو:
**محمد** يريد إدارة شبكة إنترنت MikroTik

#### الخطوة 1: إضافة الباقات
```
1. يضيف "باقة يومية" - 200 ر.ي - يوم واحد
2. يضيف "باقة أسبوعية" - 1000 ر.ي - 7 أيام
3. يضيف "باقة شهرية" - 3000 ر.ي - 30 يوم

✅ كلها محفوظة في Firebase
```

#### الخطوة 2: استيراد الكروت
```
1. يستورد 500 كرت للباقة اليومية
   → تُحفظ في Firebase مع:
      • packageId: "pkg_daily"
      • price: 200
      • expiryDate: اليوم + 1 يوم
   → stock الباقة اليومية: 0 → 500

2. يستورد 200 كرت للباقة الأسبوعية
   → stock الباقة الأسبوعية: 0 → 200

3. يستورد 100 كرت للباقة الشهرية
   → stock الباقة الشهرية: 0 → 100
```

#### الخطوة 3: المتابعة والإدارة
```
يذهب للمخزون:
• الإجمالي: 800 كرت
• متاح: 800
• مباع: 0

يفلتر حسب "باقة يومية":
• يرى 500 كرت
• كل كرت بسعر 200 ر.ي
• كل كرت صلاحيته يوم واحد
```

---

## 🔒 الأمان والجودة

### 1. **التحقق من البيانات**
```dart
✅ لا يمكن استيراد كروت بدون باقة
✅ التحقق من عدم تكرار أرقام الكروت
✅ التحقق من تسجيل الدخول
✅ التحقق من صلاحيات المستخدم
```

### 2. **التكامل**
```dart
✅ الكروت مرتبطة بمعرف الباقة (Foreign Key)
✅ السعر والصلاحية من الباقة نفسها
✅ تحديث المخزون تلقائياً
✅ مزامنة فورية عبر جميع الأجهزة
```

### 3. **قواعد Firestore المقترحة**
```javascript
// في Firebase Console:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // الباقات
    match /packages/{packageId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     request.auth.uid == request.resource.data.networkId;
    }
    
    // الكروت
    match /cards/{cardId} {
      allow read: if request.auth != null && 
                    resource.data.networkId == request.auth.uid;
      allow write: if request.auth != null && 
                     request.auth.uid == request.resource.data.networkId;
    }
  }
}
```

---

## ✨ النتيجة النهائية

```
🎉 نظام متكامل وموحد:
   ├── 📦 إدارة الباقات في Firebase
   ├── 🎫 إدارة الكروت مرتبطة بالباقات
   ├── 📊 إحصائيات حية ودقيقة
   ├── 🔄 مزامنة تلقائية
   ├── 🔒 أمان محكم
   └── ✅ بدون بيانات تجريبية
```

---

**تم التطوير في:** 2025-10-25  
**الحالة:** ✅ جاهز للاستخدام الإنتاجي

