# โ ุฅุตูุงุญ ูุธุงู ุงููุนุงููุงุช

## ๐ฏ ุงููุดููุฉ

ุนูุฏ ุงูููุงููุฉ ุนูู ุทูุจ ูุฑูุช ุฃู ุฏูุนุฉ ููุฏูุฉุ ูู ุชุธูุฑ ุงููุนุงููุงุช ูู ุชุจููุจ "ุงููุนุงููุงุช" ูู ุตูุญุฉ ุชูุงุตูู ุงูุดุจูุฉ.

---

## ๐ง ุงูุณุจุจ

### **1. ุชุณุฌูู ุงููุนุงููุงุช ุฏุงุฎู Firebase Transaction**
```dart
// ุงููุดููุฉ: ุงููุนุงููุฉ ุฏุงุฎู runTransaction
await _firestore.runTransaction((transaction) async {
  // ... ููู ุงููุฑูุช ...
  
  // ุฅูุดุงุก ูุนุงููุฉ
  transaction.set(transactionRef, {...});  // โ ูุฏ ูุง ูุนูู ุจุดูู ุตุญูุญ
});
```

**ุงููุดููุฉ:**
- โ Firebase Transaction ูุญุฏูุฏุฉ ูู ุงูููุช
- โ ูุฏ ุชูุดู ุงูุนูููุฉ ุจุฏูู ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
- โ ุงูุฃูุถู ุฃู ุชููู ุฎุงุฑุฌ ุงูู Transaction

### **2. ุงุณุชุฎุฏุงู ุญูู `reference` ุบูุฑ ููุฌูุฏ**
```dart
.where('reference', isEqualTo: 'PAY-$paymentRequestId')
```

**ุงููุดููุฉ:**
- โ `VendorTransactionModel` ูุง ูุญุชูู ุนูู ุญูู `reference`
- โ ูุญุชูู ุนูู `paymentRequestId` ููุท
- โ ุงูุงุณุชุนูุงู ููุดู ูู ุฅูุฌุงุฏ ุงููุนุงููุฉ

---

## โ ุงูุญู

### **1. ููู ุชุณุฌูู ุงููุนุงููุงุช ุฎุงุฑุฌ Transaction**

**ูู `firebase_order_service.dart`:**
```dart
await _firestore.runTransaction((transaction) async {
  // ููู ุงููุฑูุช ูุชุญุฏูุซ ุงูุทูุจ ููุท
  // ...
});

// ุฅูุดุงุก ุงููุนุงููุฉ ุฎุงุฑุฌ Transaction โ
await _firestore.collection('transactions').add({
  'vendorId': order.vendorId,
  'networkId': order.networkId,
  'type': 'charge',
  'amount': order.totalAmount,
  'description': 'ุทูุจ ูุฑูุช - ...',
  'status': 'completed',
  'orderId': order.id,
  'date': Timestamp.fromDate(now),
});
```

### **2. ุชุญุฏูุซ ุงุณุชุนูุงูุงุช ุงูุฏูุน ุงูููุฏู**

**ูู `firebase_payment_service.dart`:**

**ูุจู:**
```dart
.where('reference', isEqualTo: 'PAY-$paymentRequestId')  โ
```

**ุจุนุฏ:**
```dart
.where('paymentRequestId', isEqualTo: paymentRequestId)  โ
.where('status', isEqualTo: 'pending')
```

### **3. ุชุจุณูุท ุจููุฉ ุงูุจูุงูุงุช**

**ุงููุนุงููุฉ ุงูุขู:**
```javascript
transactions/{transactionId}:
{
  vendorId: "vendor_123",
  networkId: "network_456",
  type: "charge" | "payment",
  amount: 200.0,
  description: "ุทูุจ ูุฑูุช - 2 ุจุงูุฉ - 5 ูุฑุช",
  status: "completed" | "pending",
  orderId: "order_789",          // ููุทูุจุงุช
  paymentRequestId: "pay_012",   // ููุฏูุนุงุช
  date: Timestamp,
  createdAt: Timestamp
}
```

---

## ๐ ุณูุฑ ุงูุนูู ุงูุตุญูุญ

### **ุณููุงุฑูู 1: ุทูุจ ูุฑูุช**

```
1. ุงููุชุฌุฑ ูุฑุณู ุทูุจ:
   - 2 ุจุงูุฉ ููููุฉ
   - 3 ุจุงูุฉ ุฃุณุจูุนูุฉ
   - ุงููุฌููุน: 450 ุฑ.ู
   โ
2. ุงูุดุจูุฉ ุชูุงูู ุนูู ุงูุทูุจ:
   โโ ููู 5 ูุฑูุช ูู ูุฎุฒูู ุงูุดุจูุฉ
   โโ ุฅุถุงูุฉ 5 ูุฑูุช ุฅูู ูุฎุฒูู ุงููุชุฌุฑ
   โโ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ โ approved
   โโ ุชุณุฌูู ูุนุงููุฉ ูู transactions:
       {
         type: "charge",      โ ูุฏูู
         amount: 450.0,
         orderId: "order_123"
       }
   โ
3. ุงููุชุฌุฑ ููุชุญ ุชุจููุจ ุงููุนุงููุงุช:
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ ๐ ููุฎุต ุงูุญุณุงุจ                โ
   โ ุงูุฑุตูุฏ: 450 ุฑ.ู (ูุฏูู)        โ
   โ ุฅุฌูุงูู ุงูุดุญู: 450 ุฑ.ู         โ
   โ ุฅุฌูุงูู ุงูุฏูุน: 0 ุฑ.ู           โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
   โ โฌ๏ธ ูุฏูู                        โ
   โ ุทูุจ ูุฑูุช - 2 ุจุงูุฉ - 5 ูุฑุช    โ
   โ ููุฐ 5 ุฏูุงุฆู                    โ
   โ                     450 ุฑ.ู   โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### **ุณููุงุฑูู 2: ุฏูุนุฉ ููุฏูุฉ**

```
1. ุงูุดุจูุฉ ุชุฑุณู ุทูุจ ุฏูุนุฉ:
   - ุงููุจูุบ: 500 ุฑ.ู
   - ุงููุตู: ุฏูุนุฉ ููุฏูุฉ
   โ
2. ุฅูุดุงุก ูุนุงููุฉ ูุนููุฉ:
   {
     type: "payment",      โ ุฏุงุฆู
     amount: 500.0,
     status: "pending",    โ ูุนูู
     paymentRequestId: "pay_123"
   }
   โ
3. ุงููุชุฌุฑ ููุงูู ุนูู ุงูุฏูุนุฉ:
   โโ ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ุงูุฏูุนุฉ โ approved
   โโ ุชุญุฏูุซ ุญุงูุฉ ุงููุนุงููุฉ โ completed โ
   โ
4. ุงููุชุฌุฑ ููุชุญ ุชุจููุจ ุงููุนุงููุงุช:
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ ๐ ููุฎุต ุงูุญุณุงุจ                โ
   โ ุงูุฑุตูุฏ: -50 ุฑ.ู (ุฏุงุฆู)        โ
   โ ุฅุฌูุงูู ุงูุดุญู: 450 ุฑ.ู         โ
   โ ุฅุฌูุงูู ุงูุฏูุน: 500 ุฑ.ู         โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
   โ โฌ๏ธ ุฏุงุฆู                        โ
   โ ุฏูุนุฉ ููุฏูุฉ                     โ
   โ ููุฐ ุฏูููุฉ                      โ
   โ                     500 ุฑ.ู   โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
   โ โฌ๏ธ ูุฏูู                        โ
   โ ุทูุจ ูุฑูุช - 2 ุจุงูุฉ - 5 ูุฑุช    โ
   โ ููุฐ 5 ุฏูุงุฆู                    โ
   โ                     450 ุฑ.ู   โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Debug Console

### **ุนูุฏ ุงูููุงููุฉ ุนูู ุทูุจ:**
```
โ Transaction recorded for order: order_123
   - vendorId: vendor_456
   - networkId: network_789
   - type: charge
   - amount: 450.0
   - orderId: order_123
```

### **ุนูุฏ ุงูููุงููุฉ ุนูู ุฏูุนุฉ:**
```
โ Pending transaction created for payment request: pay_123
โ Payment transaction approved: trans_456
```

### **ุนูุฏ ูุชุญ ุชุจููุจ ุงููุนุงููุงุช:**
```
๐ Setting up transactions stream: vendorId=vendor_456, networkId=network_789
๐ฅ Transactions snapshot received: 2 transactions
   - Transaction: trans_001, type: charge, amount: 450.0
   - Transaction: trans_002, type: payment, amount: 500.0
โ Parsed 2 transactions
๐ Transactions loaded for network: 2
```

### **ุนูุฏ ุญุณุงุจ ุงูููุฎุต:**
```
๐ Calculating account summary: vendorId=vendor_456, networkId=network_789
๐ Found 2 completed transactions
   - trans_001: type=charge, amount=450.0
   - trans_002: type=payment, amount=500.0
๐ฐ Summary: charges=450.0, payments=500.0, balance=-50.0
```

---

## ๐ฏ ุงูููุงุฑุณ ุงููุทููุจุฉ

### **ุงูููุฑุณ ุงูุฌุฏูุฏ:**
```json
{
  "collectionGroup": "transactions",
  "fields": [
    { "fieldPath": "vendorId", "order": "ASCENDING" },
    { "fieldPath": "networkId", "order": "ASCENDING" },
    { "fieldPath": "paymentRequestId", "order": "ASCENDING" },
    { "fieldPath": "status", "order": "ASCENDING" }
  ]
}
```

**ุงูุบุฑุถ:**
- ุงูุจุญุซ ุนู ูุนุงููุงุช ุงูุฏูุน ุจุงุณุชุฎุฏุงู `paymentRequestId`
- ููุชุฑุฉ ุญุณุจ `status` (pending/completed)

---

## โ ุงูุงุฎุชุจุงุฑ

### **1. ุงุฎุชุจุงุฑ ุทูุจ ูุฑูุช:**
```
1. ุณุฌู ุฏุฎูู ููุชุฌุฑ
2. ุฃุฑุณู ุทูุจ ูุฑูุช ูุดุจูุฉ
3. ุณุฌู ุฏุฎูู ูุตุงุญุจ ุงูุดุจูุฉ
4. ูุงูู ุนูู ุงูุทูุจ
5. ุณุฌู ุฏุฎูู ููุชุฌุฑ ูุฑุฉ ุฃุฎุฑู
6. ุงูุชุญ ุชูุงุตูู ุงูุดุจูุฉ โ ุชุจููุจ ุงููุนุงููุงุช
7. ูุฌุจ ุฃู ุชุฑู:
   โ ูุนุงููุฉ "ุทูุจ ูุฑูุช"
   โ ููุน: ูุฏูู
   โ ุงููุจูุบ ุตุญูุญ
```

### **2. ุงุฎุชุจุงุฑ ุฏูุนุฉ ููุฏูุฉ:**
```
1. ุณุฌู ุฏุฎูู ูุตุงุญุจ ุดุจูุฉ
2. ุฃุฑุณู ุทูุจ ุฏูุนุฉ ููุฏูุฉ ูููุชุฌุฑ
3. ุณุฌู ุฏุฎูู ููุชุฌุฑ
4. ูุงูู ุนูู ุงูุฏูุนุฉ
5. ุงูุชุญ ุชูุงุตูู ุงูุดุจูุฉ โ ุชุจููุจ ุงููุนุงููุงุช
6. ูุฌุจ ุฃู ุชุฑู:
   โ ูุนุงููุฉ "ุฏูุนุฉ ููุฏูุฉ"
   โ ููุน: ุฏุงุฆู
   โ ุงููุจูุบ ุตุญูุญ
   โ ุงูุฑุตูุฏ ูุญุฏุซ
```

---

## ๐ฑ ุงููุงุฌูุฉ

### **ุชุจููุจ ุงููุนุงููุงุช:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ ููุฎุต ุงูุญุณุงุจ                    โ
โ                                     โ
โ      ุงูุฑุตูุฏ ุงูุญุงูู                 โ
โ        450 ุฑ.ู                     โ
โ                                     โ
โ ุฅุฌูุงูู ุงูุดุญู โ ุฅุฌูุงูู ุงูุฏูุน       โ
โ   1,200 ุฑ.ู  โ   750 ุฑ.ู         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โฌ๏ธ ูุฏูู                 [ููุชูู]   โ
โ ุทูุจ ูุฑูุช - 3 ุจุงูุงุช - 10 ูุฑูุช     โ
โ ููุฐ ุณุงุนุฉ                           โ
โ                       450 ุฑ.ู      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โฌ๏ธ ุฏุงุฆู                 [ููุชูู]   โ
โ ุฏูุนุฉ ููุฏูุฉ                         โ
โ ููุฐ ุณุงุนุชูู                         โ
โ                       300 ุฑ.ู      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โฌ๏ธ ูุฏูู                 [ูุนูู]    โ
โ ุทูุจ ูุฑูุช - 1 ุจุงูุฉ - 5 ูุฑูุช       โ
โ ููุฐ 3 ุณุงุนุงุช                        โ
โ                       150 ุฑ.ู      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุงูุฎูุงุตุฉ

### **ุงูุฅุตูุงุญุงุช:**
โ **ููู ุชุณุฌูู ุงููุนุงููุงุช** ุฎุงุฑุฌ Firebase Transaction  
โ **ุชุญุฏูุซ ุงุณุชุนูุงู ุงูุฏูุน** ูุงุณุชุฎุฏุงู `paymentRequestId`  
โ **ุชุจุณูุท ุจููุฉ ุงูุจูุงูุงุช** - ุฅุฒุงูุฉ ุญููู ุบูุฑ ุถุฑูุฑูุฉ  
โ **ุฅุถุงูุฉ ููุฑุณ ุฌุฏูุฏ** ูู paymentRequestId  
โ **ุฅุถุงูุฉ print statements** ููุชุดุฎูุต  

### **ุงููุชูุฌุฉ:**
- ๐ ุงููุนุงููุงุช ุชุธูุฑ ุงูุขู ุจุดูู ุตุญูุญ
- โก ุชุญุฏูุซ ููุฑู ุนูุฏ ุงูููุงููุฉ/ุงูุฑูุถ
- ๐ฐ ุงูุฑุตูุฏ ูุญุณุจ ุจุฏูุฉ
- โ ูู ุดูุก ูุนูู ููุง ูุฌุจ

---

## ๐ ูุง ุณูุญุฏุซ ุงูุขู

### **ุนูุฏ ุงูููุงููุฉ ุนูู ุทูุจ ุฌุฏูุฏ:**
```
1. ุงูููุงููุฉ ุนูู ุงูุทูุจ
   โ
2. Debug Console:
   โ Transaction recorded for order: order_123
   โ
3. ูุชุญ ุชุจููุจ ุงููุนุงููุงุช:
   ๐ฅ Transactions snapshot received: 1 transactions
   โ
4. ุงููุนุงููุฉ ุชุธูุฑ! โ
```

### **ุนูุฏ ุงูููุงููุฉ ุนูู ุฏูุนุฉ ููุฏูุฉ:**
```
1. ุงูููุงููุฉ ุนูู ุงูุฏูุนุฉ
   โ
2. Debug Console:
   โ Payment transaction approved: trans_456
   โ
3. ูุชุญ ุชุจููุจ ุงููุนุงููุงุช:
   ๐ฅ Transactions snapshot received: 2 transactions
   โ
4. ุงููุนุงููุฉ ูุญุฏุซุฉ! โ
```

---

## โฑ๏ธ ุงูุชุธุฑ 1-2 ุฏูููุฉ

ุงูููุฑุณ ุงูุฌุฏูุฏ ูู `paymentRequestId` ููุฏ ุงูุฅูุดุงุก ุงูุขู.

ุจุนุฏ ุงูุชูุงูู:
1. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู
2. ุฌุฑุจ ุงูููุงููุฉ ุนูู ุทูุจ ุฃู ุฏูุนุฉ
3. ุงูุชุญ ุชุจููุจ ุงููุนุงููุงุช
4. ูุฌุจ ุฃู ุชุธูุฑ ุงููุนุงููุงุช ุงูุขู! โ

---

**๐ ูุธุงู ุงููุนุงููุงุช ุงูุขู ูุนูู ุจุดูู ุตุญูุญ ููุณุฌู ุฌููุน ุงูุนูููุงุช!** โจ

