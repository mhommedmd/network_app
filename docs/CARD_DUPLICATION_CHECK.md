# ูุธุงู ูุญุต ุชูุฑุงุฑ ุงููุฑูุช ุนูุฏ ุงูุงุณุชูุฑุงุฏ

## ูุธุฑุฉ ุนุงูุฉ
ูุธุงู ุดุงูู ููุชูุฏู ูููุน ุงุณุชูุฑุงุฏ ุงููุฑูุช ุงูููุฑุฑุฉุ ูุถูู ูุฒุงูุฉ ุงููุฎุฒูู ูุนุฏู ูุฌูุฏ ุชุถุงุฑุจ ูู ุฃุฑูุงู ุงููุฑูุช.

## ุฃูููุฉ ุงููุธุงู
- **ููุน ุงูุชูุฑุงุฑ:** ุชุฌูุจ ุงุณุชูุฑุงุฏ ููุณ ุฑูู ุงููุฑุช ูุฑุชูู
- **ุญูุงูุฉ ุงููุฎุฒูู:** ุงูุญูุงุธ ุนูู ุณูุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู:** ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูููุตูุฉ
- **ุชูููุฑ ุงูููุช:** ุงููุญุต ุงููุณุจู ูุจู ุงูุงุณุชูุฑุงุฏ

## ูุณุชููุงุช ุงููุญุต

### ุงููุณุชูู ุงูุฃูู: ูุญุต ุงูุชูุฑุงุฑ ุฏุงุฎู ุงูููู ุงููุณุชูุฑุฏ โ

ููุญุต ุงููุธุงู ุงูููู ุงููุณุชูุฑุฏ (CSV, Excel, PDF, TXT) ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูุฑูุช ููุฑุฑุฉ ููู.

```dart
final duplicates = _findDuplicates(parsedCards);
if (duplicates.isNotEmpty) {
  final displayDuplicates = duplicates.take(5).join(', ');
  final moreCount = duplicates.length > 5 ? ' ู${duplicates.length - 5} ุฃุฎุฑู' : '';
  _showError(
    'ุชู ุงูุนุซูุฑ ุนูู ${duplicates.length} ููุฏ ููุฑุฑ ุฏุงุฎู ุงูููู:\n$displayDuplicates$moreCount',
  );
  return;
}
```

**ุงูุขููุฉ:**
- ูุณุชุฎุฏู `Set` ููุชุญูู ูู ุงูุชูุฑุงุฑ ุจููุงุกุฉ O(n)
- ูุนุฑุถ ุฃูู 5 ูุฑูุช ููุฑุฑุฉ ูููุณุชุฎุฏู
- ูููู ุงูุนูููุฉ ููุฑุงู ุฅุฐุง ููุฌุฏ ุชูุฑุงุฑ

### ุงููุณุชูู ุงูุซุงูู: ูุญุต ุงูุชุนุงุฑุถ ูุน Firebase (ุงููุชุงุญ ูุงูููููู) ๐ฅ

**ุงูุฃูุซุฑ ุฃูููุฉ:** ููุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุงููุฑูุช ูู:
- ุงููุฑูุช ุงููุชุงุญุฉ (`CardStatus.available`)
- ุงููุฑูุช ุงููููููุฉ ูููุชุงุฌุฑ (`CardStatus.transferred`)

```dart
// ุนุฑุถ ูุคุดุฑ ุชุญููู
showDialog<void>(
  context: context,
  barrierDismissible: false,
  builder: (context) => Center(
    child: Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        CircularProgressIndicator(),
        SizedBox(height: 16.h),
        Text('ุฌุงุฑู ูุญุต ุงูุชุนุงุฑุถุงุช ูุน ุงููุฎุฒูู...'),
      ],
    ),
  ),
);

final firebaseConflicts = await _findConflictsWithFirebase(parsedCards);

if (firebaseConflicts.isNotEmpty) {
  final displayConflicts = firebaseConflicts.take(5).join(', ');
  final moreCount = firebaseConflicts.length > 5 ? ' ู${firebaseConflicts.length - 5} ุฃุฎุฑู' : '';
  _showError(
    'ุชู ุงูุนุซูุฑ ุนูู ${firebaseConflicts.length} ููุฏ ููุฌูุฏ ูุณุจูุงู ูู ุงููุฎุฒูู (ูุชุงุญ ุฃู ููููู):\n$displayConflicts$moreCount\n\nโ๏ธ ูุง ูููู ุงุณุชูุฑุงุฏ ูุฑูุช ููุฌูุฏุฉ ูุณุจูุงู',
  );
  return;
}
```

**ุขููุฉ ุงููุญุต:**
```dart
Future<Set<String>> _findConflictsWithFirebase(List<String> codes) async {
  final authProvider = Provider.of<AuthProvider>(context, listen: false);
  final networkId = authProvider.user?.id ?? '';

  if (networkId.isEmpty) {
    return <String>{};
  }

  try {
    // 1. ุฌูุจ ุงููุฑูุช ุงููุชุงุญุฉ
    final availableCards = await FirebaseCardService.getCardsByStatusOnce(
      networkId,
      CardStatus.available,
    );
    
    // 2. ุฌูุจ ุงููุฑูุช ุงููููููุฉ
    final transferredCards = await FirebaseCardService.getCardsByStatusOnce(
      networkId,
      CardStatus.transferred,
    );

    // 3. ุฅูุดุงุก ูุฌููุนุฉ ูู ุฃุฑูุงู ุงููุฑูุช ุงูููุฌูุฏุฉ
    final existingCardNumbers = <String>{
      ...availableCards.map((c) => c.cardNumber),
      ...transferredCards.map((c) => c.cardNumber),
    };

    // 4. ูุญุต ุงูุชุนุงุฑุถุงุช
    final conflicts = <String>{};
    for (final code in codes) {
      if (existingCardNumbers.contains(code)) {
        conflicts.add(code);
      }
    }

    return conflicts;
  } catch (e) {
    print('ุฎุทุฃ ูู ูุญุต ุงูุชุนุงุฑุถุงุช: $e');
    return <String>{};
  }
}
```

### ุงููุณุชูู ุงูุซุงูุซ: ูุญุต ุงููุฎุฒูู ุงููุญูู (ุฅุถุงูู) ๐ฆ

ูุญุต ุฅุถุงูู ูุน ุงููุฎุฒูู ุงููุญูู (`InventoryRepository`) ููุชูุงูู ูุน ุงููุธุงู ุงููุฏูู.

```dart
final inventoryConflicts = _findConflictsWithInventory(editedCards);
if (inventoryConflicts.isNotEmpty) {
  final displayConflicts = inventoryConflicts.take(5).join(', ');
  final moreCount = inventoryConflicts.length > 5 ? ' ู${inventoryConflicts.length - 5} ุฃุฎุฑู' : '';
  _showError(
    'ุจุนุถ ุงูุฃููุงุฏ ููุฌูุฏุฉ ูู ุงููุฎุฒูู ุงููุญูู:\n$displayConflicts$moreCount',
  );
  return;
}
```

## ุชุฏูู ุนูููุฉ ุงููุญุต

```mermaid
graph TD
    A[ุงุฎุชูุงุฑ ููู ุงููุฑูุช] --> B{ูุญุต ุงููุณุชูู 1}
    B -->|ุชูุฑุงุฑ ุฏุงุฎูู| C[โ ุฑูุถ ุงูุงุณุชูุฑุงุฏ]
    B -->|ูุง ุชูุฑุงุฑ| D[ุนุฑุถ ูุคุดุฑ ุงูุชุญููู]
    D --> E{ูุญุต Firebase}
    E -->|ูุฑูุช ููุฌูุฏุฉ| F[โ ุฑูุถ ุงูุงุณุชูุฑุงุฏ]
    E -->|ูุง ุชุนุงุฑุถ| G{ูุญุต ุงููุฎุฒูู ุงููุญูู}
    G -->|ุชุนุงุฑุถ| H[โ ุฑูุถ ุงูุงุณุชูุฑุงุฏ]
    G -->|ูุง ุชุนุงุฑุถ| I[โ ุงูุณูุงุญ ุจุงูุงุณุชูุฑุงุฏ]
    
    C --> J[ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ููุตูุฉ]
    F --> J
    H --> J
    I --> K[ุญูุธ ุงููุฑูุช ูู Firebase]
```

## ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ูุคุดุฑุงุช ุงูุชุญููู

ุนูุฏ ูุญุต Firebaseุ ูุชู ุนุฑุถ ูุคุดุฑ ุชุญููู ูุงุถุญ:

```dart
Center(
  child: Column(
    mainAxisSize: MainAxisSize.min,
    children: [
      CircularProgressIndicator(),
      SizedBox(height: 16.h),
      Text(
        'ุฌุงุฑู ูุญุต ุงูุชุนุงุฑุถุงุช ูุน ุงููุฎุฒูู...',
        style: TextStyle(
          color: Colors.white,
          fontSize: 14.sp,
          fontWeight: FontWeight.w600,
        ),
      ),
    ],
  ),
)
```

### ุฑุณุงุฆู ุงูุฎุทุฃ ุงูููุตูุฉ

#### 1. ุชูุฑุงุฑ ุฏุงุฎู ุงูููู
```
ุชู ุงูุนุซูุฑ ุนูู 3 ููุฏ ููุฑุฑ ุฏุงุฎู ุงูููู:
123456789, 987654321, 456789123
```

#### 2. ุชุนุงุฑุถ ูุน Firebase
```
ุชู ุงูุนุซูุฑ ุนูู 5 ููุฏ ููุฌูุฏ ูุณุจูุงู ูู ุงููุฎุฒูู (ูุชุงุญ ุฃู ููููู):
111222333, 444555666, 777888999, 123123123, 456456456

โ๏ธ ูุง ูููู ุงุณุชูุฑุงุฏ ูุฑูุช ููุฌูุฏุฉ ูุณุจูุงู
```

#### 3. ุฃูุซุฑ ูู 5 ูุฑูุช ููุฑุฑุฉ
```
ุชู ุงูุนุซูุฑ ุนูู 15 ููุฏ ููุฑุฑ ุฏุงุฎู ุงูููู:
123456789, 987654321, 456789123, 789456123, 321654987 ู10 ุฃุฎุฑู
```

## ุงูุฃุฏุงุก ูุงูุชุญุณููุงุช

### 1. ุงุณุชุฎุฏุงู Set ูููุญุต ุงูุณุฑูุน
```dart
final seen = <String>{};
final duplicates = <String>{};
for (final code in codes) {
  if (!seen.add(code)) {
    duplicates.add(code);
  }
}
```
- **ุงูุชุนููุฏ ุงูุฒููู:** O(n)
- **ุงูุชุนููุฏ ุงูููุงูู:** O(n)

### 2. ุฌูุจ ุงูุจูุงูุงุช ูุฑุฉ ูุงุญุฏุฉ
ุงุณุชุฎุฏุงู `getCardsByStatusOnce` ุจุฏูุงู ูู `Stream` ูุชูููุฑ:
- ุงุณุชููุงู ุงูุฐุงูุฑุฉ
- ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช ูู Firebase
- ููุช ุงูุชูููุฐ

### 3. ุงููุญุต ุงููุชูุงุฒู
```dart
// ุฌูุจ ุงููุฑูุช ุงููุชุงุญุฉ ูุงููููููุฉ ุจุดูู ูุชุฒุงูู
final results = await Future.wait([
  FirebaseCardService.getCardsByStatusOnce(networkId, CardStatus.available),
  FirebaseCardService.getCardsByStatusOnce(networkId, CardStatus.transferred),
]);
```

## ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### ุณููุงุฑูููุงุช ุงูุฎุทุฃ:

1. **ูุดู ุงูุงุชุตุงู ุจู Firebase**
   - ูุชู ุชุฌุงูู ุงููุญุต ูุงูุงุณุชูุฑุงุฑ
   - ุทุจุงุนุฉ ุฑุณุงูุฉ ูู Console ููุชุดุฎูุต

2. **ุดุจูุฉ ุบูุฑ ุตุงูุญุฉ**
   - ุฅุฑุฌุงุน `Set` ูุงุฑุบ
   - ุนุฏู ุฅููุงู ุงูุนูููุฉ

3. **ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูุจูุงูุงุช**
   - ูุนุงูุฌุฉ ุดุงููุฉ ุจู `try-catch`
   - ุฅุฑุฌุงุน `Set` ูุงุฑุบ ููุฃูุงู

## ุงูุงุณุชุฎุฏุงู

### ูู ูุจู ุงููุทูุฑ:

```dart
// ูู ุตูุญุฉ ุงุณุชูุฑุงุฏ ุงููุฑูุช
Future<void> _handleFileSelect() async {
  // ... ูุฑุงุกุฉ ุงูููู ...
  
  // ูุญุต ุงูุชูุฑุงุฑ
  final duplicates = _findDuplicates(parsedCards);
  if (duplicates.isNotEmpty) {
    _showError('ูุฑูุช ููุฑุฑุฉ');
    return;
  }
  
  // ูุญุต Firebase
  final conflicts = await _findConflictsWithFirebase(parsedCards);
  if (conflicts.isNotEmpty) {
    _showError('ูุฑูุช ููุฌูุฏุฉ ูุณุจูุงู');
    return;
  }
  
  // ุงูุณูุงุญ ุจุงูุงุณุชูุฑุงุฏ
  // ...
}
```

### ูู ูุจู ุงููุณุชุฎุฏู:

1. ุงุฎุชุฑ ุงูุจุงูุฉ
2. ุญุฏุฏ ุนุฏุฏ ุฃุฑูุงู ุงููุฑุช
3. ุงุณุชุนุฑุถ ุงูููู
4. ุงูุชุธุฑ ุงููุญุต ุงูุชููุงุฆู
5. ุฅุฐุง ูุฌุญ ุงููุญุตุ ููููู ุงููุชุงุจุนุฉ

## ุงููููุงุช ุงููุนุฏูุฉ

### 1. `import_cards_page.dart`
- ุฅุถุงูุฉ `_findConflictsWithFirebase()`
- ุชุญุฏูุซ `_handleFileSelect()`
- ุชุญุฏูุซ `_handleImportCards()`
- ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ

### 2. `firebase_card_service.dart`
- ุฅุถุงูุฉ `getCardsByStatusOnce()` ููุญุตูู ุนูู ุงููุฑูุช ูุฑุฉ ูุงุญุฏุฉ

## ุงูููุงุฆุฏ

โ **ููุน ุงูุชูุฑุงุฑ ุจูุณุจุฉ 100%**
โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ**
โ **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูููุตูุฉ**
โ **ุฃุฏุงุก ูุญุณูู**
โ **ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก**
โ **ุชูุงูู ูุน ุงูุฃูุธูุฉ ุงููุฏููุฉ**

## ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ:

1. **ุงุณุชูุฑุงุฏ ููู ุจุฏูู ุชูุฑุงุฑ** โ
2. **ุงุณุชูุฑุงุฏ ููู ุจูุฑูุช ููุฑุฑุฉ ุฏุงุฎููุงู** โ
3. **ุงุณุชูุฑุงุฏ ูุฑูุช ููุฌูุฏุฉ ูู ุงููุฎุฒูู ุงููุชุงุญ** โ
4. **ุงุณุชูุฑุงุฏ ูุฑูุช ููุฌูุฏุฉ ูู ุงููุฎุฒูู ุงูููููู** โ
5. **ุงุณุชูุฑุงุฏ ูุฑูุช ุฌุฒุฆูุฉ (ุจุนุถูุง ููุฌูุฏ)** โ
6. **ูุดู ุงูุงุชุตุงู ุจู Firebase** โ๏ธ (ูุณุชูุฑ)

## ุงูุตูุงูุฉ

### ููุงุท ุงููุฑุงูุจุฉ:
- ูุฑุงูุจุฉ ุงุณุชููุงู Firebase Reads
- ุชุญุณูู ููุช ุงูุงุณุชุนูุงู ุนูุฏ ุฒูุงุฏุฉ ุงูุจูุงูุงุช
- ุฅุถุงูุฉ ุชุฎุฒูู ูุคูุช (Cache) ูููุฑูุช ุงูููุฌูุฏุฉ
- ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ ุจูุงุกู ุนูู ููุงุญุธุงุช ุงููุณุชุฎุฏููู

## ุงูุชุทููุฑ ุงููุณุชูุจูู

### ุชุญุณููุงุช ููุชุฑุญุฉ:
1. **ุชุฎุฒูู ูุคูุช ูููุฑูุช** - ุชูููู ุงุณุชุนูุงูุงุช Firebase
2. **ูุญุต ุชุฏุฑูุฌู** - ูุญุต ุฏูุนุงุช ุตุบูุฑุฉ ูููููุงุช ุงููุจูุฑุฉ
3. **ุฅุญุตุงุฆูุงุช ููุตูุฉ** - ุนุฑุถ ุชูุฑูุฑ ุดุงูู ุนู ุงููุญุต
4. **ุชุตุฏูุฑ ุงูุชูุงุฑูุฑ** - ุชุตุฏูุฑ ุงููุฑูุช ุงูููุฑุฑุฉ ูููู
5. **ูุญุต ุฐูู** - ุงูุชุฑุงุญุงุช ูุญู ุงูุชุนุงุฑุถุงุช

## ุงูุฏุนู

ูููุฒูุฏ ูู ุงููุนูููุงุชุ ุฑุงุฌุน:
- [ูุธุงู ุงูุจุงูุงุช ูุงููุฑูุช](PACKAGES_AND_CARDS_SYSTEM.md)
- [ูุธุงู ุชุชุจุน ุงููุฑูุช](CARD_TRACKING_SYSTEM.md)
- [ุฏููู Firebase](FIREBASE_CARDS_STORAGE.md)

