# دليل نظام الطلبات المتعددة - Multi-Package Orders Guide

## 🎯 التحديثات الجديدة

تم تحديث نظام الطلبات ليدعم:
- ✅ **اختيار عدة باقات في طلب واحد**
- ✅ **تحديد كمية لكل باقة**
- ✅ **إخفاء الكمية المتوفرة عن المتجر**
- ✅ **التحقق من التوفر عند الموافقة فقط**

---

## 📱 الواجهة الجديدة

### **صفحة إرسال الطلب (محدثة):**

```
┌────────────────────────────────────┐
│  ←    شبكة النور للإنترنت          │  ⭐ اسم الشبكة
└────────────────────────────────────┘
│  اختر الباقات والكميات            │
├────────────────────────────────────┤
│  ┌──────────────────────────────┐ │
│  │ 📶 باقة يومية اقتصادية      │ │
│  │    السعر: 800 ر.ي            │ │
│  │ ──────────────────────────   │ │
│  │ الكمية:    ⊖  25  ⊕         │ │
│  │ المجموع الفرعي: 20,000 ر.ي  │ │
│  └──────────────────────────────┘ │
│                                    │
│  ┌──────────────────────────────┐ │
│  │ 📶 باقة أسبوعية             │ │
│  │    السعر: 4,000 ر.ي          │ │
│  │ ──────────────────────────   │ │
│  │ الكمية:    ⊖  50  ⊕         │ │
│  │ المجموع الفرعي: 200,000 ر.ي │ │
│  └──────────────────────────────┘ │
│                                    │
│  ┌──────────────────────────────┐ │
│  │ 📶 باقة شهرية VIP            │ │
│  │    السعر: 12,000 ر.ي         │ │
│  │ ──────────────────────────   │ │
│  │ الكمية:    ⊖  0  ⊕          │ │
│  └──────────────────────────────┘ │
└────────────────────────────────────┘
┌────────────────────────────────────┐
│  إجمالي الكروت: 75 كرت            │
│  المجموع الكلي: 220,000 ر.ي        │
│                                    │
│       [📤 إرسال الطلب]             │
└────────────────────────────────────┘
```

### **بطاقة الطلب (الشبكة):**

```
┌────────────────────────────────────┐
│  🏪 متجر الأمل            🟡      │  ← قيد الانتظار
│     منذ 30 دقيقة                  │
├────────────────────────────────────┤
│  ┌────────────────────────────┐   │
│  │ 📦 باقة يومية اقتصادية    │   │  ⭐ عدة باقات
│  │    25 كرت × 800 ر.ي        │   │
│  │             20,000 ر.ي     │   │
│  └────────────────────────────┘   │
│                                    │
│  ┌────────────────────────────┐   │
│  │ 📦 باقة أسبوعية           │   │
│  │    50 كرت × 4,000 ر.ي      │   │
│  │             200,000 ر.ي    │   │
│  └────────────────────────────┘   │
│                                    │
│  🎫 إجمالي الكروت: 75              │
│                                    │
│  ──────────────────────────────    │
│  المجموع الكلي: 220,000 ر.ي        │
│                                    │
│  [✕ رفض]           [✓ موافقة]     │
└────────────────────────────────────┘
```

---

## 🔄 آلية العمل

### **1. المتجر يرسل طلب:**

```
1. يفتح صفحة إرسال الطلب
2. يرى جميع الباقات المتاحة
3. لا يرى الكمية المتوفرة ❌
4. يحدد الكمية لكل باقة:
   ├─ باقة يومية: 25 كرت
   ├─ باقة أسبوعية: 50 كرت
   └─ باقة شهرية: 0 كرت (لا يختارها)
5. يرسل الطلب بدون التحقق من التوفر ✅
```

### **2. الشبكة تستقبل الطلب:**

```
1. ترى الطلب في تاب "الطلبات"
2. ترى قائمة بجميع الباقات المطلوبة
3. ترى الكمية لكل باقة
4. المجموع الكلي
```

### **3. الموافقة على الطلب:**

```
عند الموافقة:
├─ النظام يتحقق من توفر كل باقة ✅
├─ إذا متوفر: ينقل الكروت
└─ إذا غير متوفر: 
   ├─ رسالة خطأ: "المخزون غير كافٍ للباقة '...'"
   ├─ "متوفر: 30، مطلوب: 50"
   └─ الشبكة تستورد كروت أولاً ثم توافق
```

---

## 🏗️ البنية الفنية

### **OrderModel (محدث):**

```dart
class OrderModel {
  final String id;
  final String vendorId;
  final String vendorName;
  final String networkId;
  final String networkName;
  final List<OrderItemModel> items;  ⭐ الجديد!
  final double totalAmount;
  final String status;
  final DateTime createdAt;
  
  // حساب إجمالي الكروت
  int get totalCards => items.fold(0, (sum, item) => sum + item.quantity);
}
```

### **OrderItemModel (جديد):**

```dart
class OrderItemModel {
  final String packageId;
  final String packageName;
  final int quantity;
  final double pricePerCard;
  final double totalAmount;
}
```

### **مثال في Firebase:**

```json
{
  "id": "order_001",
  "vendorId": "vendor_123",
  "vendorName": "متجر الأمل",
  "networkId": "network_456",
  "networkName": "شبكة النور",
  "items": [                    ⭐ array من الباقات
    {
      "packageId": "pkg_789",
      "packageName": "باقة يومية",
      "quantity": 25,
      "pricePerCard": 800,
      "totalAmount": 20000
    },
    {
      "packageId": "pkg_790",
      "packageName": "باقة أسبوعية",
      "quantity": 50,
      "pricePerCard": 4000,
      "totalAmount": 200000
    }
  ],
  "totalAmount": 220000,        ⭐ المجموع الكلي
  "status": "pending",
  "createdAt": "2025-10-26..."
}
```

---

## 🧪 الاختبار

### **الخطوة 1: إعداد البيانات**

#### **أضف شبكة وباقات:**

```
users → networkOwner:
  networkName: "شبكة النور"
  governorate: "صنعاء"

packages:
  1. باقة يومية (purchasePrice: 800)
  2. باقة أسبوعية (purchasePrice: 4000)
  3. باقة شهرية (purchasePrice: 12000)

cards:
  لكل باقة: 100 كرت (status: available)
```

### **الخطوة 2: إرسال طلب متعدد**

```
1. سجل دخول كـ posVendor
2. أضف الشبكة
3. افتح تفاصيل الشبكة
4. اضغط "إرسال طلب"
5. حدد:
   ├─ باقة يومية: 25 كرت
   ├─ باقة أسبوعية: 50 كرت
   └─ اترك باقة شهرية: 0
6. تحقق من الملخص:
   ├─ إجمالي الكروت: 75
   └─ المجموع: 220,000 ر.ي
7. اضغط "إرسال الطلب"
8. ✅ يجب أن تنجح العملية
```

### **الخطوة 3: الموافقة**

```
1. سجل دخول كـ networkOwner
2. اذهب لتاب "الطلبات"
3. يجب أن ترى الطلب مع:
   ├─ باقة يومية: 25 كرت
   └─ باقة أسبوعية: 50 كرت
4. اضغط "موافقة"
5. انتظر (سينقل 75 كرت)
6. ✅ "تمت الموافقة وتم نقل الكروت"
```

### **الخطوة 4: التحقق**

```
في حساب الشبكة:
├─ المخزون → باقة يومية: 75 كرت (100-25)
└─ المخزون → باقة أسبوعية: 50 كرت (100-50)

في حساب المتجر:
├─ تفاصيل الشبكة → باقة يومية: 25 كرت ✅
└─ تفاصيل الشبكة → باقة أسبوعية: 50 كرت ✅
```

---

## 🎨 التغييرات في الواجهة

### **قبل:**
```
❌ اختيار باقة واحدة فقط
❌ كمية واحدة
❌ يرى الكمية المتوفرة
❌ يتحقق من التوفر قبل الإرسال
```

### **بعد:**
```
✅ اختيار عدة باقات
✅ كمية منفصلة لكل باقة
✅ لا يرى الكمية المتوفرة
✅ يرسل مباشرة
✅ الشبكة تتحقق عند الموافقة
```

---

## ⚙️ الوظائف المحدثة

### **في send_order_page.dart:**

```dart
// خريطة لحفظ الكمية لكل باقة
Map<String, int> _packageQuantities = {};

// تحديث الكمية
void _updateQuantity(String packageId, int quantity) {
  if (quantity > 0) {
    _packageQuantities[packageId] = quantity;
  } else {
    _packageQuantities.remove(packageId);
  }
}

// حساب المجموع الكلي
double _calculateTotalAmount(List<PackageModel> packages) {
  double total = 0;
  for (var pkg in packages) {
    final quantity = _getQuantity(pkg.id);
    if (quantity > 0) {
      total += pkg.purchasePrice * quantity;
    }
  }
  return total;
}

// إنشاء الطلب
final items = <OrderItemModel>[];
for (var pkg in packages) {
  final quantity = _getQuantity(pkg.id);
  if (quantity > 0) {
    items.add(OrderItemModel(...));
  }
}
```

### **في firebase_order_service.dart:**

```dart
// الموافقة مع معالجة عدة باقات
Future<void> approveOrder(OrderModel order) async {
  await _firestore.runTransaction((transaction) async {
    // لكل باقة في الطلب
    for (final item in order.items) {
      // 1. احصل على الكروت
      final cardsQuery = await _firestore
          .collection('cards')
          .where('packageId', '==', item.packageId)
          .where('status', '==', 'available')
          .limit(item.quantity)
          .get();
      
      // 2. تحقق من التوفر
      if (cardsQuery.docs.length < item.quantity) {
        throw Exception('المخزون غير كافٍ...');
      }
      
      // 3. انقل كل كرت
      for (final cardDoc in cardsQuery.docs) {
        // نقل إلى vendor_cards
        // تحديث في cards
      }
    }
    
    // 4. حدث حالة الطلب
  });
}
```

---

## 🧪 أمثلة الاستخدام

### **مثال 1: طلب باقة واحدة**

```
المتجر يطلب:
├─ باقة يومية: 100 كرت
└─ المجموع: 80,000 ر.ي

Firebase:
{
  "items": [
    {
      "packageId": "pkg_001",
      "packageName": "باقة يومية",
      "quantity": 100,
      "pricePerCard": 800,
      "totalAmount": 80000
    }
  ],
  "totalAmount": 80000
}
```

### **مثال 2: طلب عدة باقات**

```
المتجر يطلب:
├─ باقة يومية: 25 كرت → 20,000 ر.ي
├─ باقة أسبوعية: 50 كرت → 200,000 ر.ي
└─ باقة شهرية: 10 كرت → 120,000 ر.ي
────────────────────────────────────
    المجموع الكلي: 340,000 ر.ي

Firebase:
{
  "items": [
    {
      "packageId": "pkg_001",
      "packageName": "باقة يومية",
      "quantity": 25,
      "pricePerCard": 800,
      "totalAmount": 20000
    },
    {
      "packageId": "pkg_002",
      "packageName": "باقة أسبوعية",
      "quantity": 50,
      "pricePerCard": 4000,
      "totalAmount": 200000
    },
    {
      "packageId": "pkg_003",
      "packageName": "باقة شهرية",
      "quantity": 10,
      "pricePerCard": 12000,
      "totalAmount": 120000
    }
  ],
  "totalAmount": 340000
}
```

---

## 🔐 سيناريوهات الموافقة

### **سيناريو 1: الكمية متوفرة بالكامل**

```
الطلب:
├─ باقة يومية: 25 كرت
└─ باقة أسبوعية: 50 كرت

المخزون:
├─ باقة يومية: 100 كرت متاح ✅
└─ باقة أسبوعية: 80 كرت متاح ✅

النتيجة:
✅ الموافقة تنجح
✅ نقل 75 كرت
✅ تحديث المخزون
```

### **سيناريو 2: باقة واحدة غير متوفرة**

```
الطلب:
├─ باقة يومية: 25 كرت
└─ باقة أسبوعية: 50 كرت

المخزون:
├─ باقة يومية: 100 كرت متاح ✅
└─ باقة أسبوعية: 30 كرت متاح ❌

النتيجة:
❌ خطأ: "المخزون غير كافٍ للباقة 'باقة أسبوعية'"
❌ "متوفر: 30، مطلوب: 50"
📌 لا يتم نقل أي شيء (Firebase Transaction)
📌 الشبكة تستورد كروت ثم توافق
```

### **سيناريو 3: كل الباقات غير متوفرة**

```
الطلب:
├─ باقة يومية: 25 كرت
└─ باقة أسبوعية: 50 كرت

المخزون:
├─ باقة يومية: 10 كرت متاح ❌
└─ باقة أسبوعية: 20 كرت متاح ❌

النتيجة:
❌ خطأ فور التحقق من أول باقة
📌 لا يتم نقل أي كروت
📌 الطلب يبقى قيد الانتظار
📌 الشبكة تستورد كروت
```

---

## 💡 فوائد التحديث

### **للمتجر:**
- ✅ **طلب واحد بدلاً من عدة طلبات**
- ✅ **لا يرى مخزون الشبكة** (خصوصية)
- ✅ **مرونة أكثر** في الطلب
- ✅ **واجهة أسهل**

### **للشبكة:**
- ✅ **رؤية واضحة** لما هو مطلوب
- ✅ **تحكم كامل** في الموافقة
- ✅ **معرفة النواقص** بدقة
- ✅ **قرار مبني على المخزون الفعلي**

### **للنظام:**
- ✅ **معاملات آمنة** (Transactions)
- ✅ **إما كل الكروت أو لا شيء**
- ✅ **لا تناقضات في البيانات**
- ✅ **أداء أفضل** (طلب واحد بدلاً من عدة)

---

## 🎯 حالات الاستخدام

### **حالة 1: متجر صغير**
```
يطلب باقة واحدة بكمية صغيرة:
├─ باقة يومية: 10 كرت
└─ سهل ومباشر
```

### **حالة 2: متجر متوسط**
```
يطلب عدة باقات:
├─ باقة يومية: 50 كرت
├─ باقة أسبوعية: 30 كرت
└─ طلب واحد شامل
```

### **حالة 3: متجر كبير**
```
يطلب جميع الباقات:
├─ باقة يومية: 100 كرت
├─ باقة أسبوعية: 80 كرت
├─ باقة شهرية: 50 كرت
└─ طلب ضخم منظم
```

---

## ✅ الملفات المحدثة

```
✏️ Models:
   - order_model.dart (محدث)
   - order_item_model.dart (جديد)

✏️ Services:
   - firebase_order_service.dart (محدث)

✏️ Pages:
   - send_order_page.dart (محدث بالكامل)
   - networks_page.dart (تحديث _VendorOrderCard)

✏️ Widgets:
   - order_card.dart (محدث)

✏️ Config:
   - main.dart (حذف OrderProvider)
```

---

## 🎉 النتيجة

### **قبل التحديث:**
```
❌ باقة واحدة فقط
❌ يرى الكمية المتوفرة
❌ يتحقق قبل الإرسال
❌ عدة طلبات لباقات متعددة
```

### **بعد التحديث:**
```
✅ عدة باقات في طلب واحد
✅ لا يرى الكمية المتوفرة
✅ يرسل مباشرة
✅ الشبكة تتحقق عند الموافقة
✅ مرونة أكبر
✅ خصوصية أفضل
```

---

**🚀 النظام الآن أكثر احترافية ومرونة!** ✨

**المتجر:**
✅ يختار ما يريد دون قيود  
✅ لا يرى مخزون الشبكة (خصوصية)  

**الشبكة:**
✅ تتحكم بالموافقة بناءً على المخزون  
✅ تستورد كروت إذا لزم الأمر  

**🎊 تجربة مستخدم ممتازة!** 🎉

