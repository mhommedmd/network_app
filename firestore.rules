rules_version = '2';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase Security Rules Ù„ØªØ·Ø¨ÙŠÙ‚ Network Management
// Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 28 Ø£ÙƒØªÙˆØ¨Ø± 2025
// 
// ğŸ”´ Ù…Ù‡Ù…: ÙŠØ¬Ø¨ Ù†Ø´Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙÙŠ Firebase Console
// ğŸ“– Ø±Ø§Ø¬Ø¹: DEPLOY_FIREBASE_RULES.md Ù„Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

service cloud.firestore {
  match /databases/{database}/documents {
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Helper Functions - Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserId() {
      return request.auth.uid;
    }
    
    function isNetworkOwner() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(getUserId())) &&
             get(/databases/$(database)/documents/users/$(getUserId())).data.type == 'networkOwner';
    }
    
    function isVendor() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(getUserId())) &&
             get(/databases/$(database)/documents/users/$(getUserId())).data.type == 'posVendor';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Users Collection - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /users/{userId} {
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
      allow read: if isAuthenticated();
      
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­ØªÙ‰ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
      allow create: if isAuthenticated() && getUserId() == userId;
      
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„
      allow update: if isAuthenticated() && getUserId() == userId;
      
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© (create + update) Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨
      allow write: if isAuthenticated() && getUserId() == userId;
      
      // Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨
      allow delete: if isAuthenticated() && getUserId() == userId;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Packages Collection - Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /packages/{packageId} {
      allow read: if isAuthenticated();
      allow create: if isNetworkOwner();
      allow update, delete: if isNetworkOwner() && 
                              resource.data.networkId == getUserId();
    }
    
    // Cards collection
    match /cards/{cardId} {
      allow read: if isAuthenticated();
      allow create: if isNetworkOwner();
      
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ§Ù„Ø­Ø°Ù
      allow update, delete: if isNetworkOwner() && 
                              resource.data.networkId == getUserId();
      
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØ¬Ø± Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ±Øª Ø¥Ù„Ù‰ 'sold' ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹
      allow update: if isVendor() && 
                      resource.data.status == 'transferred' &&
                      request.resource.data.status == 'sold';
    }
    
    // Vendor cards collection
    match /vendor_cards/{cardId} {
      allow read: if isAuthenticated() && 
                    (resource.data.vendorId == getUserId() || 
                     resource.data.networkId == getUserId());
      allow write: if isAuthenticated();
    }
    
    // Orders collection
    match /orders/{orderId} {
      allow read: if isAuthenticated() && 
                    (resource.data.vendorId == getUserId() || 
                     resource.data.networkId == getUserId());
      allow create: if isVendor();
      allow update: if isAuthenticated() && 
                      (resource.data.vendorId == getUserId() || 
                       resource.data.networkId == getUserId());
      // Ø§Ù„Ø­Ø°Ù: Ù…Ø§Ù„Ùƒ Ø§Ù„Ø´Ø¨ÙƒØ© ÙÙ‚Ø·ØŒ ÙˆÙÙ‚Ø· Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (approved Ø£Ùˆ rejected)
      allow delete: if isNetworkOwner() && 
                      resource.data.networkId == getUserId() &&
                      resource.data.status in ['approved', 'rejected'];
    }
    
    // Transactions collection
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && 
                    (resource.data.vendorId == getUserId() || 
                     resource.data.networkId == getUserId());
      allow create: if isAuthenticated();
    }
    
    // Vendor transactions collection
    match /vendor_transactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.vendorId == getUserId();
      allow create: if isAuthenticated();
    }
    
    // Sales collection
    match /sales/{saleId} {
      allow read: if isAuthenticated() && 
                    (resource.data.vendorId == getUserId() || 
                     resource.data.networkId == getUserId());
      allow create: if isVendor();
    }
    
    // Network connections collection
    match /network_connections/{connectionId} {
      allow read: if isAuthenticated() && 
                    (resource.data.vendorId == getUserId() || 
                     resource.data.networkId == getUserId());
      allow create: if isAuthenticated() && 
                      request.resource.data.vendorId == getUserId();
      allow update, delete: if isAuthenticated() && 
                              (resource.data.vendorId == getUserId() || 
                               resource.data.networkId == getUserId());
    }
    
    // Vendors collection
    // ÙŠØ³ØªØ®Ø¯Ù… composite key: {networkId}_{vendorId}
    // Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ù„Ù†ÙØ³ Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø¹Ø¯Ø© Ø´Ø¨ÙƒØ§Øª
    match /vendors/{compositeId} {
      allow read: if isAuthenticated();
      allow create: if isNetworkOwner() && 
                      request.resource.data.networkId == getUserId();
      allow update, delete: if isNetworkOwner() && 
                              resource.data.networkId == getUserId();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â­ Cash Payment Requests - Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (Ø§Ù„Ø£Ù‡Ù…!)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /cash_payment_requests/{requestId} {
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡
      allow read, write: if isAuthenticated();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Notifications - Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /notifications/{notificationId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙÙ‚Ø·
      allow read, update, delete: if isAuthenticated() && 
                                     resource.data.userId == getUserId();
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡
      allow create: if isAuthenticated();
    }
  }
}

