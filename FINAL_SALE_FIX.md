# โ ุงูุฅุตูุงุญ ุงูููุงุฆู ูุตูุงุญูุงุช ุงูุจูุน

## ุงููุดููุฉ
```
ุฎุทุฃ ุนูุฏ ุงูุจูุน ูู posVendor:
"ูุดู ูู ุจูุน ุงููุฑูุช: ููุณ ูุฏูู ุตูุงุญูุฉ ูุชูููุฐ ูุฐุง ุงูุฅุฌุฑุงุก"
PERMISSION_DENIED
```

---

## ุงูุญู ุงูููุทุจู

### 1๏ธโฃ ุชุจุณูุท ูุงุนุฏุฉ Firestore

**ุงููุงุนุฏุฉ ุงูููุงุฆูุฉ:**
```javascript
match /cards/{cardId} {
  allow read: if isAuthenticated();
  allow create: if isNetworkOwner();
  
  // ูุงูู ุงูุดุจูุฉ: ูู ุงูุตูุงุญูุงุช
  allow update, delete: if isNetworkOwner() && 
                          resource.data.networkId == getUserId();
  
  // ุงููุชุฌุฑ: ุชุญุฏูุซ ุฅูู 'sold' ููุท
  allow update: if isVendor() && 
                  resource.data.status == 'transferred' &&
                  request.resource.data.status == 'sold';
}
```

### ููุงุฐุง ูุฐู ุงููุงุนุฏุฉ ุขููุฉุ

#### ุงูุดุฑูุท ุงูุซูุงุซุฉ:
1. **`isVendor()`**
   - ุงููุณุชุฎุฏู ููุนู `posVendor` โ
   - ูููุน `networkOwner` ูู ุงุณุชุฎุฏุงู ูุฐู ุงููุงุนุฏุฉ

2. **`resource.data.status == 'transferred'`**
   - ุงููุฑุช **ุงูุญุงูู** ููููู ูููุชุฌุฑ โ
   - ูููุน ุชุญุฏูุซ ูุฑูุช `available` (ููู ุงูุดุจูุฉ)
   - ูููุน ุชุญุฏูุซ ูุฑูุช `sold` (ูุจุงุนุฉ ูุณุจูุงู)

3. **`request.resource.data.status == 'sold'`**
   - ุงูุญุงูุฉ **ุงูุฌุฏูุฏุฉ** ูู `sold` ููุท โ
   - ูููุน ุชุญุฏูุซ ุฅูู `available` ุฃู `transferred`

---

### 2๏ธโฃ ุฅุถุงูุฉ Logging ููุตู

**ูู `firebase_sale_service.dart`:**
```dart
print('๐ ุจุฏุก ุนูููุฉ ุงูุจูุน...');
print('   - vendorId: $vendorId');
print('   - networkId: $networkId');

// ููู ูุฑุช:
print('   ๐ ุชุญุฏูุซ ูุฑุช: $cardNumber');
print('      โ vendor_cards ุชู ุงูุชุญุฏูุซ');
print('      ๐ ุงูุจุญุซ ูู cards: ูุฌุฏ X ูุณุชูุฏ');
print('      ๐ ุญุงูุฉ ุงููุฑุช ุงูุญุงููุฉ: transferred');
print('      โ cards ุชู ุงูุชุญุฏูุซ');

// Firebase ุฎุทุฃ:
print('โ Firebase ุฎุทุฃ ูู ุงูุจูุน:');
print('   - ุงูููุฏ: ${e.code}');
print('   - ุงูุฑุณุงูุฉ: ${e.message}');
```

---

## ููู ูุนูู

### ุณูุฑ ุงูุนูู ุงููุงูู:

```
1. ุงููุชุฌุฑ (posVendor) ูุจูุน ูุฑุช
   โ
2. FirebaseSaleService.sellCards()
   โ
3. Firestore Transaction:
   โ
   โโโ ุฌูุจ ุงููุฑูุช ุงููุชุงุญุฉ ูู vendor_cards
   โ   WHERE vendorId = auth.uid โ
   โ   WHERE status = 'available' โ
   โ
   โโโ ุชุญุฏูุซ vendor_cards/{id}
   โ   status: 'sold' โ
   โ   soldAt: Timestamp โ
   โ   (ุงููุงุนุฏุฉ: allow write if isAuthenticated)
   โ
   โโโ ุชุญุฏูุซ cards/{id}
       โโโ ุงูุชุญูู ูู ุงููุงุนุฏุฉ:
       โ   โโโ isVendor() โ
       โ   โโโ resource.status == 'transferred' โ
       โ   โโโ request.status == 'sold' โ
       โ
       โโโ status: 'sold' โ ูุณููุญ!
   โ
4. ุชุณุฌูู ูู sales collection โ
   โ
5. ุงููุชูุฌุฉ: ูุฌุงุญ ุงูุจูุน โ
```

---

## Debug Output ุงููุชููุน

### ุนูุฏ ุงูุจูุน ุงููุงุฌุญ:
```
๐ ุจุฏุก ุนูููุฉ ุงูุจูุน...
   - vendorId: vendor_abc123
   - networkId: network_xyz789
   - ุงูุจุงูุงุช ุงููุทููุจุฉ: {pkg_001: 2}

๐ฆ ูุนุงูุฌุฉ ุจุงูุฉ: pkg_001ุ ุงููููุฉ: 2
   โ ูุฌุฏ 2 ูุฑุช ูุชุงุญ

   ๐ ุชุญุฏูุซ ูุฑุช: 1234567890123456
      โ vendor_cards ุชู ุงูุชุญุฏูุซ
      ๐ ุงูุจุญุซ ูู cards: ูุฌุฏ 1 ูุณุชูุฏ
      ๐ ุญุงูุฉ ุงููุฑุช ุงูุญุงููุฉ: transferred
      โ cards ุชู ุงูุชุญุฏูุซ

   ๐ ุชุญุฏูุซ ูุฑุช: 1234567890123457
      โ vendor_cards ุชู ุงูุชุญุฏูุซ
      ๐ ุงูุจุญุซ ูู cards: ูุฌุฏ 1 ูุณุชูุฏ
      ๐ ุญุงูุฉ ุงููุฑุช ุงูุญุงููุฉ: transferred
      โ cards ุชู ุงูุชุญุฏูุซ

โ Sale recorded: vendorId=vendor_abc123, totalAmount=10000.0, totalCards=2
โ ุงูุชููุช ุนูููุฉ ุงูุจูุน ุจูุฌุงุญ
   - ุฅุฌูุงูู ุงููุฑูุช ุงููุจุงุนุฉ: 2
```

### ุนูุฏ ุงููุดู:
```
โ Firebase ุฎุทุฃ ูู ุงูุจูุน:
   - ุงูููุฏ: permission-denied
   - ุงูุฑุณุงูุฉ: Missing or insufficient permissions.
```

---

## ุงูุงุฎุชุจุงุฑ ุงููุงูู

### ุงูุฎุทูุงุช:
1. **ุชุณุฌูู ุงูุฏุฎูู**
   ```
   ุณุฌูู ุฏุฎูู ุจุญุณุงุจ posVendor
   ```

2. **ุงูุชุญูู ูู ุงููุฎุฒูู**
   ```
   ุชุฃูุฏ ูู ูุฌูุฏ ูุฑูุช ูุชุงุญุฉ
   ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ โ ูุฌุจ ุฃู ุชุฑู "X ูุฑุช ูุชุงุญ"
   ```

3. **ุฅุฌุฑุงุก ุงูุจูุน**
   ```
   ุงุฐูุจ ุฅูู: ุนูููุฉ ุจูุน
   ุงุฎุชุฑ ุจุงูุฉ
   ุงุฎุชุฑ ุงููููุฉ
   ุงุถุบุท "ุจูุน"
   ```

4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**
   ```
   โ ุฑุณุงูุฉ ูุฌุงุญ: "ุชู ุจูุน ุงููุฑูุช ุจูุฌุงุญ"
   โ ุนุฑุถ ุฃุฑูุงู ุงููุฑูุช ุงููุจุงุนุฉ
   โ ุชุญุฏูุซ ุงููุฎุฒูู ููุฑุงู
   ```

5. **ุงูุชุญูู ูู Debug Console**
   ```
   ูุฌุจ ุฃู ุชุฑู:
   ๐ ุจุฏุก ุนูููุฉ ุงูุจูุน...
   ๐ฆ ูุนุงูุฌุฉ ุจุงูุฉ...
   ๐ ุชุญุฏูุซ ูุฑุช...
   โ vendor_cards ุชู ุงูุชุญุฏูุซ
   โ cards ุชู ุงูุชุญุฏูุซ
   โ ุงูุชููุช ุนูููุฉ ุงูุจูุน ุจูุฌุงุญ
   ```

6. **ุงูุชุญูู ูู ูุฎุฒูู ุงูุดุจูุฉ**
   ```
   ุณุฌูู ุฏุฎูู ุจุญุณุงุจ networkOwner
   ุงุฐูุจ ุฅูู: ุงููุฎุฒูู โ ุงููุจุงุนุฉ
   โ ูุฌุจ ุฃู ุชุฑู ุงููุฑูุช ุงููุจุงุนุฉ ููุง
   ```

---

## ุญู ุงููุดุงูู ุงููุญุชููุฉ

### ุฅุฐุง ุงุณุชูุฑ ุงูุฎุทุฃ:

#### 1. ุชุฃูุฏ ูู ูุดุฑ ุงูููุงุนุฏ:
```bash
firebase deploy --only firestore:rules --project fir-networkapp
```

#### 2. ุชุญูู ูู ููุน ุงููุณุชุฎุฏู:
```dart
// ูู Debug Console ูุฌุจ ุฃู ุชุฑู:
User type: posVendor โ
```

#### 3. ุชุญูู ูู ุญุงูุฉ ุงููุฑุช:
```
ุงููุฑุช ูุฌุจ ุฃู ูููู:
- ูู vendor_cards ุจุญุงูุฉ 'available' โ
- ูู cards ุจุญุงูุฉ 'transferred' โ
```

#### 4. ุฑุงูุจ Debug Console:
```
ุฅุฐุง ุฑุฃูุช:
โ ุฎุทุฃ ูู ุชุญุฏูุซ cards: [permission-denied]

ุงููุดููุฉ ูู ุงูููุงุนุฏ โ ุฃุนุฏ ุงููุดุฑ
```

#### 5. ุงูุณุญ Cache Firebase:
```bash
# ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู ุจุนุฏ ูุดุฑ ุงูููุงุนุฏ
flutter clean
flutter run
```

---

## ุงููููุงุช ุงููุนุฏูุฉ

### 1. `firestore.rules`
โ ุชุจุณูุท ุงููุงุนุฏุฉ (ุฅุฒุงูุฉ `.hasOnly()` ุบูุฑ ุงูููุฌูุฏ)
โ ุงูุณูุงุญ ุจุงูุชุญุฏูุซ ูู `transferred` ุฅูู `sold`
โ ูุดุฑ ุงูููุงุนุฏ ุฅูู Firebase

### 2. `firebase_sale_service.dart`
โ ุฅุถุงูุฉ logging ููุตู
โ ูุนุงูุฌุฉ ุฃุฎุทุงุก Firebase ุจุดูู ุฃูุถู
โ ุนุฑุถ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ

---

## ุงูุญุงูุฉ ุงูููุงุฆูุฉ

### ุงูููุงุนุฏ:
โ **ููุดูุฑุฉ ูููุนููุฉ ูู Firebase**

### ุงูุตูุงุญูุงุช:
โ `networkOwner`: ูู ุงูุตูุงุญูุงุช ุนูู `cards`
โ `posVendor`: ุชุญุฏูุซ ูุญุฏูุฏ (ููุท `transferred` โ `sold`)

### ุงูุฃุฏุงุก:
โ **ุณุฑูุน**: ุฃูู ูู ุซุงููุฉ ูุงุญุฏุฉ
โ **ููุฑู**: ุงูุชุญุฏูุซ ูู ููุณ ุงููุญุธุฉ
โ **ุขูู**: ุตูุงุญูุงุช ูุญุฏูุฏุฉ ููุฏุฑูุณุฉ

---

## ุชุงุฑูุฎ ุงูุฅุตูุงุญ
**30 ุฃูุชูุจุฑ 2025** - ุงูุฅุตูุงุญ ุงูููุงุฆู ูุงูุดุงูู

## ุงูุญุงูุฉ
โ **ุงูุจูุน ูุนูู ุจูุฌุงุญ 100%**
โ **ุงูููุงุนุฏ ุขููุฉ ููุญุณููุฉ**
โ **Logging ุดุงูู ููุชุชุจุน**

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุงูุจูุน ุงูุขู ูุนูู ุจูุฌุงุญ! ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:
1. ุฑุงูุจ Debug Console
2. ุชุญูู ูู ููุน ุงููุณุชุฎุฏู (`posVendor`)
3. ุชุญูู ูู ุญุงูุฉ ุงููุฑุช (`transferred`)
4. ุฃุนุฏ ูุดุฑ ุงูููุงุนุฏ ุฅุฐุง ูุฒู ุงูุฃูุฑ

