# ๐ง ุฅุตูุงุญ ูุธุงู ุงููุนุงููุงุช ูุงูุฑุตูุฏ

## โ ุงููุดุงูู ุงููููุชุดูุฉ

### **1. ุงูุฏูุนุงุช ุงูููุฏูุฉ ูุง ุชุธูุฑ ูู ูุงุฆูุฉ ุงููุนุงููุงุช**
**ุงูุณุจุจ:**
- ุงููุนุงููุฉ ูุงูุช ุชูุณุฌู ุจุฏูู ุญูู `date`
- ุงูุงุณุชุนูุงู ูุญุงูู ุงูุชุฑุชูุจ ุญุณุจ `date` โ ูุดู
- ุงููุนุงููุฉ ููุฌูุฏุฉ ูู Firebase ููู ูุง ุชุธูุฑ ูู ุงููุงุฆูุฉ

### **2. ุงูุฑุตูุฏ ูุง ููุนุฑุถ ุจุดูู ุตุญูุญ**
**ุงูุณุจุจ:**
- ุงูููุฏ ูุนุฑุถ `_vendor!.balance` ูู ูููุฐุฌ Vendor
- ููู ูุฐุง ุงูุฑุตูุฏ ุซุงุจุช ููุง ูุชุญุฏุซ ูุน ุงููุนุงููุงุช ุงูุฌุฏูุฏุฉ
- ุงูุฑุตูุฏ ุงููุนูู ูุฌุจ ุฃู ููุญุณุจ ูู ุงููุนุงููุงุช

### **3. ููุน ูุนุงููุฉ ุงูุฏูุนุฉ ุงูููุฏูุฉ**
**ุงูุณุจุจ:**
- ุงูุฏูุนุฉ ููุณุฌูุฉ ูู `cash_payment_received`
- ููู ุญุณุงุจ ุงูุฑุตูุฏ ูุง ูุชุนุฑู ุนูู ูุฐุง ุงูููุน
- ูุฌุจ ุฅุถุงูุชู ูุฃููุงุน ุงููุฏููุนุงุช

---

## โ ุงูุญููู ุงูููุทุจูุฉ

### **1. ุฅุถุงูุฉ ุงูุญููู ุงููุทููุจุฉ ูููุนุงููุฉ**

#### **ูุจู:**
```dart
transaction.set(networkTransactionRef, {
  'networkId': networkId,
  'vendorId': vendorId,
  'type': 'cash_payment_received',
  'amount': amount,
  'status': 'completed',
  'createdAt': FieldValue.serverTimestamp(),
});
```

#### **ุจุนุฏ:**
```dart
final now = DateTime.now();
transaction.set(networkTransactionRef, {
  'networkId': networkId,
  'vendorId': vendorId,
  'vendorName': vendorName,
  'type': 'cash_payment_received',
  'amount': amount,
  'description': 'ุฏูุนุฉ ููุฏูุฉ ูู $vendorName',
  'reference': 'PAY-${requestId.substring(0, 8).toUpperCase()}',
  'status': 'completed',
  'date': Timestamp.fromDate(now), // โ ููู ููุชุฑุชูุจ
  'createdAt': Timestamp.fromDate(now),
  'createdBy': networkId,
  'method': 'cash',
  'balanceAfter': 0.0,
  'paymentRequestId': requestId,
});
```

**ุงูุญููู ุงูููุถุงูุฉ:**
- โ `date` - ููุชุฑุชูุจ ูู ุงูุงุณุชุนูุงูุงุช
- โ `reference` - ูุฑุฌุน ูุงุถุญ (PAY-XXXXXXXX)
- โ `description` - ูุตู ุงููุนุงููุฉ
- โ `method` - ุทุฑููุฉ ุงูุฏูุน (cash)
- โ `createdBy` - ูู ุฃูุดุฃ ุงููุนุงููุฉ

### **2. ุชุญุฏูุซ ุญุณุงุจ ุงูุฑุตูุฏ**

#### **ูู `firebase_transaction_service.dart`:**

**ูุจู:**
```dart
if (type == 'charge' || type == 'fee') {
  totalCharges += amount.abs();
} else if (type == 'payment' || type == 'refund') {
  totalPayments += amount.abs();
}
```

**ุจุนุฏ:**
```dart
// ุงููุณุชุญูุงุช (charges): ุทูุจุงุช ุงููุฑูุช
if (type == 'charge' || type == 'fee') {
  totalCharges += amount.abs();
} 
// ุงููุฏููุนุงุช (payments): ุงูุฏูุนุงุช ุงูููุฏูุฉ
else if (type == 'payment' || type == 'refund' || type == 'cash_payment_received') {
  totalPayments += amount.abs();
}

// ุญุณุงุจ ุงูุฑุตูุฏ = ุงููุณุชุญูุงุช - ุงููุฏููุนุงุช
final balance = totalCharges - totalPayments;
```

**ุงูุชุบููุฑุงุช:**
- โ ุฅุถุงูุฉ `cash_payment_received` ูุฃููุงุน ุงููุฏููุนุงุช
- โ ุชุบููุฑ ุงุณู ุงููุชุบูุฑ ูู `currentBalance` ุฅูู `balance`
- โ ุฅุฑุฌุงุน `'balance'` ูู Map ุจุฏูุงู ูู `'currentBalance'`

### **3. ุนุฑุถ ุงูุฑุตูุฏ ุงูุตุญูุญ**

#### **ูู `merchant_transactions_page.dart`:**

**ูุจู:**
```dart
Text(
  '${_vendor!.balance >= 0 ? '+' : ''}${_formatNumber(_vendor!.balance)}',
  // ...
)
```

**ุจุนุฏ:**
```dart
Text(
  '${(_accountSummary?['balance'] as double?) != null && (_accountSummary!['balance'] as double) >= 0 ? '+' : ''}${_formatNumber((_accountSummary?['balance'] as double?) ?? _vendor!.balance)}',
  // ...
)
```

**ุงูุชุบููุฑ:**
- โ ุนุฑุถ ุงูุฑุตูุฏ ูู `accountSummary['balance']`
- โ Fallback ุฅูู `_vendor!.balance` ุฅุฐุง ูู ูุชููุฑ
- โ ุงูุฑุตูุฏ ููุญุณุจ ูู ุงููุนุงููุงุช ุงููุนููุฉ

---

## ๐ ููู ูุนูู ุงููุธุงู ุงูุขู

### **1. ุชุฏูู ุชุณุฌูู ุงูุทูุจ:**
```
1. ูุชุฌุฑ ูุฑุณู ุทูุจ ูุฑูุช
   โ
2. ูุงูู ุงูุดุจูุฉ ููุงูู
   โ
3. ุชูุณุฌู ูุนุงููุฉ ูู transactions
   type: "charge"
   amount: ุฅูุฌุงุจู
   โ
4. ุชูุถุงู ูููุณุชุญูุงุช (totalCharges)
```

### **2. ุชุฏูู ุชุณุฌูู ุงูุฏูุนุฉ:**
```
1. ูุงูู ุงูุดุจูุฉ ูุฑุณู ุฏูุนุฉ ููุฏูุฉ
   โ
2. ุงููุชุฌุฑ ููุงูู
   โ
3. ุชูุณุฌู ูุนุงููุฉ ูู transactions
   type: "cash_payment_received"
   amount: ุฅูุฌุงุจู
   โ
4. ุชูุถุงู ูููุฏููุนุงุช (totalPayments)
```

### **3. ุญุณุงุจ ุงูุฑุตูุฏ:**
```
ุงูุฑุตูุฏ = ุงููุณุชุญูุงุช - ุงููุฏููุนุงุช
balance = totalCharges - totalPayments

ูุซุงู:
- ุทูุจุงุช: 162,000 + 6,480 = 168,480 ุฑ.ู (ูุณุชุญูุงุช)
- ุฏูุนุงุช: 11,555 ุฑ.ู (ูุฏููุนุงุช)
- ุงูุฑุตูุฏ = 168,480 - 11,555 = 156,925 ุฑ.ู

ูุนูู ุงูุฑุตูุฏ:
- ุฅูุฌุงุจู (+): ุงููุชุฌุฑ ูุฏูู ููุงูู ุงูุดุจูุฉ
- ุณุงูุจ (-): ูุงูู ุงูุดุจูุฉ ูุฏูู ูููุชุฌุฑ
```

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### โ **ุงูุฏูุนุงุช ุชูุณุฌู ุจุดูู ุตุญูุญ:**
- ุชุธูุฑ ูู ูุงุฆูุฉ ุงููุนุงููุงุช
- ููุง ูุฑุฌุน ูุงุถุญ (PAY-XXXXXXXX)
- ููุฑุชุจุฉ ุญุณุจ ุงูุชุงุฑูุฎ

### โ **ุงูุฑุตูุฏ ููุญุณุจ ุจุฏูุฉ:**
- ูุนูุณ ุฌููุน ุงูุทูุจุงุช ูุงูุฏูุนุงุช
- ูุชุญุฏุซ ููุฑุงู ูุน ูู ูุนุงููุฉ ุฌุฏูุฏุฉ
- ููุนุฑุถ ุจุดูู ุตุญูุญ ูู ุตูุญุฉ ุงููุนุงููุงุช

### โ **ูุงุฆูุฉ ุงููุนุงููุงุช ุดุงููุฉ:**
```
ุงููุนุงููุงุช ุชุดูู:
1. ุทูุจุงุช ุงููุฑูุช (charge)
2. ุงูุฏูุนุงุช ุงูููุฏูุฉ (cash_payment_received)
3. ุงูุฑุณูู (fee)
4. ุงูุงุณุชุฑุฌุงุนุงุช (refund)
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### **ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ:**

1. **ุงูุชุญ ุญุณุงุจ ูุงูู ุงูุดุจูุฉ**
2. **ุฃุฑุณู ุฏูุนุฉ ููุฏูุฉ (5000 ุฑ.ู) ููุชุฌุฑ**
3. **ุงูุชูู ูุญุณุงุจ ุงููุชุฌุฑ**
4. **ุงูุชุญ ุตูุญุฉ ุงูุฏูุนุงุช ุงูููุฏูุฉ**
5. **ูุงูู ุนูู ุงูุฏูุนุฉ**

### **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**

โ ูู ุญุณุงุจ ูุงูู ุงูุดุจูุฉ:
- ุตูุญุฉ ุงููุนุงููุงุช โ ูุธูุฑ ุณุฌู "ุฏูุนุฉ ููุฏูุฉ ูู [ุงุณู ุงููุชุฌุฑ]"
- ุงููุฑุฌุน: PAY-XXXXXXXX
- ุงููุจูุบ: +5,000 ุฑ.ู (ูู ุงููุฏููุนุงุช)

โ ูู ุตูุญุฉ ูุนุงููุงุช ุงููุชุฌุฑ:
- ุงูุฑุตูุฏ ููู ุจููุฏุงุฑ 5,000 ุฑ.ู
- ุงููุนุงููุฉ ุชุธูุฑ ูู ุงููุงุฆูุฉ
- ุฅุฌูุงูู ุงููุฏููุนุงุช ูุฒูุฏ

---

## ๐ ููุงุญุธุงุช ูููุฉ

### **1. ุฃููุงุน ุงููุนุงููุงุช:**
```dart
'charge'                  // ุทูุจ ูุฑูุช (ูุณุชุญู)
'fee'                     // ุฑุณูู (ูุณุชุญู)
'payment'                 // ุฏูุนุฉ ุนุงุฏูุฉ (ูุฏููุน)
'cash_payment_received'   // ุฏูุนุฉ ููุฏูุฉ (ูุฏููุน) โ
'refund'                  // ุงุณุชุฑุฌุงุน (ูุฏููุน)
```

### **2. ุงูุญููู ุงูุฅูุฒุงููุฉ:**
```dart
{
  'networkId',    // ูุนุฑู ุงูุดุจูุฉ
  'vendorId',     // ูุนุฑู ุงููุชุฌุฑ
  'type',         // ููุน ุงููุนุงููุฉ
  'amount',       // ุงููุจูุบ
  'description',  // ุงููุตู
  'reference',    // ุงููุฑุฌุน
  'status',       // ุงูุญุงูุฉ
  'date',         // ุงูุชุงุฑูุฎ โ๏ธ ููู ุฌุฏุงู
  'createdAt',    // ููุช ุงูุฅูุดุงุก
}
```

### **3. ุงููุฑุฌุน (Reference):**
```
ุทูุจุงุช: ORD-XXXXXXXX
ุฏูุนุงุช: PAY-XXXXXXXX
```

---

## โ ุชู ุงูุงูุชูุงุก!

๐ **ูุธุงู ุงููุนุงููุงุช ูุนูู ุจุดูู ูุงูู:**
- โ ุงูุทูุจุงุช ุชูุณุฌู
- โ ุงูุฏูุนุงุช ุชูุณุฌู
- โ ุงูุฑุตูุฏ ููุญุณุจ ุจุฏูุฉ
- โ ูู ุดูุก ูุธูุฑ ูู ูุงุฆูุฉ ุงููุนุงููุงุช

**ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐**

